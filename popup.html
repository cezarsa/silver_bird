<!DOCTYPE html>
<html>
<head>
<!-- Theme specific CSS files are loaded later by the ThemeManager -->
<link id="base_stylesheet" rel="stylesheet" type="text/css" href="css/base.css" />
<link rel="stylesheet" type="text/css" href="css/action_menu.css" />
<link rel="stylesheet" type="text/css" href="css/simple_select.css" />
<link rel="stylesheet" type="text/css" href="css/tipsy.css" />
<link rel="stylesheet" type="text/css" href="css/jquery.contextMenu.css" />
<title>Chromed Bird</title>
<script>
var MAX_TWEET_SIZE = 140;
var Persistence = chrome.extension.getBackgroundPage().Persistence;
var urlExpander = chrome.extension.getBackgroundPage().urlExpander;
var tweetManager = chrome.extension.getBackgroundPage().TweetManager.instance;
var twitterBackend = tweetManager.twitterBackend;
var OptionsBackend = chrome.extension.getBackgroundPage().OptionsBackend;
var TimelineTemplate = chrome.extension.getBackgroundPage().TimelineTemplate;
var ImageService = chrome.extension.getBackgroundPage().ImageService;
var UploadManager = chrome.extension.getBackgroundPage().UploadManager;

chrome.i18n.getMessage = chrome.extension.getBackgroundPage().chrome.i18n.getMessage;

var microbloggingService = OptionsBackend.get('microblogging_service');
var TwitterLib;
if(microbloggingService == 'twitter') {
  TwitterLib = {
    URLS: {
      BASE: 'http://twitter.com/',
      SEARCH: 'http://twitter.com/search?q='
    }
  };
} else if(microbloggingService == 'identica') {
  TwitterLib = {
    URLS: {
      BASE: 'http://identi.ca/',
      SEARCH: 'http://identi.ca/search/notice?q='
    }
  };
}

if(!twitterBackend.authenticated() && !twitterBackend.tokenRequested()) {
  twitterBackend.startAuthentication();
  window.close();
}
</script>

<script type="text/javascript" src="lib/3rdparty/jquery.js"></script>
<script type="text/javascript" src="lib/3rdparty/jquery-ui-custom.js"></script>
<script type="text/javascript" src="lib/3rdparty/jquery.autocomplete.mod.js"></script>
<script type='text/javascript' src='lib/3rdparty/jquery.tipsy.js'></script>
<script type="text/javascript" src="lib/3rdparty/jquery.contextMenu.js"></script>
<script type="text/javascript" src="lib/3rdparty/jquery.insertatcaret.min.js"></script>
<script type="text/javascript" src="lib/3rdparty/oauth.js"></script>
<script type="text/javascript" src="lib/3rdparty/sha1.js"></script>

<!--script type="text/javascript" src="lib/debug.js"></script-->
<script type="text/javascript" src="lib/any_click.js"></script>
<script type="text/javascript" src="lib/shortener_lib.js"></script>
<script type="text/javascript" src="lib/simple_select.js"></script>
<script type="text/javascript" src="lib/tweet_transforms.js"></script>
<script type="text/javascript" src="lib/action_menu.js"></script>
<script type="text/javascript" src="lib/tweets_assembler.js"></script>
<script>
$.ajaxSetup({
  timeout: OptionsBackend.get('request_timeout')
});

var url_shortener = OptionsBackend.get('url_shortener');
var shortener_acct = OptionsBackend.get('shortener_acct');
var shortener_login = null;
var shortener_key = null;
if(shortener_acct) {
  shortener_login = OptionsBackend.get('shortener_login');
  shortener_key = OptionsBackend.get('shortener_key');
}

if (url_shortener == 'yourls'){
  shortener_key = OptionsBackend.get('yourls_key');
} else if( url_shortener == 'googl' ){
  shortener_acct = OptionsBackend.get('shortener_oauth');
}

var reply_all = OptionsBackend.get('reply_all');
var shortener = new Shortener(url_shortener, shortener_acct, 
			      shortener_login, shortener_key, 
			      OptionsBackend.get('shortener_service_url'));

$.extend($.ui.tabs.prototype, {
  refreshPositions: function() {
    return this._tabify();
  }
});

$.fn.hoverFor = function(time, mainCallback, startingCallback, abortCallback) {
  return this.each(function(){
    var _this = this, timeoutHandle, triggerFired = false;
    $(this).hover(
      function() {
        if(triggerFired)
          return;
        if(startingCallback)
          startingCallback.call(_this);
        timeoutHandle = setTimeout(function() {
          triggerFired = true;
          mainCallback.call(_this);
          timeoutHandle = null;
        }, time);
      },
      function() {
        if(triggerFired)
          return;
        if(timeoutHandle) {
          if(abortCallback)
            abortCallback.call(_this);
          clearTimeout(timeoutHandle);
          timeoutHandle = null;
        }
      }
    );
 });
};

var myOAuth = {
  registerPin: function() {
    var pinNumber = $("input[name='pin']").val();
    $("#loading_oauth").show();
    twitterBackend.oauthLib.getAccessToken(pinNumber, function(result) {
      $("#loading_oauth").hide();
      $("#enter_pin").hide();
      if(result) {
        initializeWorkspace();
      } else {
        var errMsg = twitterBackend.oauthLib.error;
        $("#error_pin").show().html(chrome.i18n.getMessage("oAuthError", errMsg));
      }
    });
  },
  requestNewToken: function() {
    twitterBackend.startAuthentication();
    window.close();
  }
};

var Paginator = {
  needsMore: false,
  firstPage: function(shouldScrollTop) {
    this.needsMore = false;
    if(shouldScrollTop) {
      $("#timeline-" + tweetManager.currentTimelineId + ' .inner_timeline').scrollTop(0);
      tweetManager.getCurrentTimeline().currentScroll = 0;
    }
  },
  nextPage: function() {
    this.needsMore = true;
    loadTimeline();
  }
};

var ThemeManager = {
  init: function () {
    $("link.theme").remove();
    var theme = OptionsBackend.get('theme');
    $(theme.split(",")).each(function(i, p) {
      $("<link rel='stylesheet' type='text/css' class='theme' href='" + p + "'>").appendTo(document.head);
    });
    var baseStyle = $("#base_stylesheet")[0];
    if(baseStyle.sheet && baseStyle.sheet.cssRules) {
      var baseRules = baseStyle.sheet.cssRules;
      var fontFamily = OptionsBackend.get('font_family');
      var fontSize = OptionsBackend.get('font_size');
      for(var i = 0, len = baseRules.length; i < len; ++i) {
        var rule = baseRules[i];
        if(rule.selectorText == ".tweet") {
          rule.style.fontFamily = fontFamily;
          rule.style.fontSize = fontSize;
          break;
        }
      }
    }

    ThemeManager.isPopup = location.search == '?popup';
    ThemeManager.isDetached = location.search == '?detached';

    if(!ThemeManager.isPopup) {
      $('<base target="_blank">').appendTo(document.head);
    }

    var persistedPosition = Persistence.windowPosition();
    ThemeManager.detachedPos = persistedPosition.val();
    if(!ThemeManager.detachedPos) {
      // Setting default values
      ThemeManager.detachedPos = {
        left: 100,
        top: 100,
        height: null,
        width: null
      };
      persistedPosition.save(ThemeManager.detachedPos);
    }
    if(ThemeManager.isDetached) {
      $("#detach_img").hide();
      // Listening to resize and move events
      $(window).resize(function() {
        ThemeManager.detachedPos.height = window.innerHeight;
        ThemeManager.detachedPos.width = window.innerWidth;
        persistedPosition.save(ThemeManager.detachedPos);
      });
      setInterval(function() {
        if(ThemeManager.detachedPos.left != window.screenLeft || ThemeManager.detachedPos.top != window.screenTop) {
          ThemeManager.detachedPos.left = window.screenLeft;
          ThemeManager.detachedPos.top = window.screenTop;
          persistedPosition.save(ThemeManager.detachedPos);
        }
      }, 1000);
    }
  },

  setPopupSize: function(width, height, autoFitWidth) {
    if(!ThemeManager.isPopup) {
      return;
    }

    /* HACK: Magic numbers */
    var hackBordersWidth = 14;
    var hackTabsAdditionalWidth = 40;
    var hackHeaderHeight = 75;
    var hackMinValidHeight = 400;

    width = width || 490;
    height = height || 400;
    var minWidth = 450;
    var maxWidth = 800 - hackBordersWidth;
    if(width > maxWidth) {
      width = maxWidth;
    }
    if(width < minWidth) {
      width = minWidth;
    }
    if(autoFitWidth) {
      setTimeout(function() {
        var tabsBarWidth = 0;
        $("li.timeline_tab").each(function() {
          tabsBarWidth += $(this).width();
        });
        tabsBarWidth += hackTabsAdditionalWidth;
        if(tabsBarWidth > width) {
          ThemeManager.setPopupSize(tabsBarWidth, height);
        }
      }, 300);
    }

    $(".timeline").width(width + 'px');
    $(".inner_timeline,.timeline").height(height + 'px');

    setTimeout(function() {
      if(window.innerHeight < hackMinValidHeight) { return; }
      if(window.innerHeight < ($(".timeline").height() + hackHeaderHeight)) {
        var height = window.innerHeight - hackHeaderHeight;
        ThemeManager.setPopupSize(width, height, autoFitWidth);
      }
    }, 100);
  },

  popupSizeData: Persistence.popupSize(),

  initWindowResizing: function() {
    ThemeManager.handleWindowResizing();
    if(!ThemeManager.isPopup) {
      var resizeFunc = function() {
        var timelineHeight = window.innerHeight - 79;
        $('.inner_timeline,.timeline').css('maxHeight', timelineHeight + 'px');
      };
      $(window).resize(resizeFunc);
      resizeFunc();
      return;
    }
    $(".timeline").resizable({
      handles: 'e, s, se',
      minWidth: 450,
      resize: function(e, ui) {
        var $this = $(this);
        ThemeManager.setPopupSize($this.width(), $this.height());
      },
      stop: function(e, ui) {
        var $this = $(this);
        ThemeManager.popupSizeData.save($this.width() + 'x' + $this.height());
      }
    });
    $(".ui-resizable-handle").attr('title', chrome.i18n.getMessage("resetSize"));
    $(".ui-resizable-handle").dblclick(function(e) {
      ThemeManager.popupSizeData.remove();
      ThemeManager.setPopupSize(null, null, true);
    });
  },

  handleWindowResizing: function() {
    var sizeArray = ThemeManager.popupSizeData.val();
    if(sizeArray) {
      sizeArray = sizeArray.split('x');
      ThemeManager.setPopupSize(sizeArray[0], sizeArray[1], true);
    } else {
      ThemeManager.setPopupSize(null, null, true);
    }
  },

  sortableEl: null,
  uiTabs: null,
  handleSortableTabs: function() {
    this.uiTabs = $("#tabs");
    this.sortableEl = this.uiTabs.find(".ui-tabs-nav");
    this.sortableEl.sortable({
      stop: function(event, ui) {
        ThemeManager.updateTabsOrder();
      }
    });
  },

  reOrderPanels: function(sortedTimelines) {
    var panels = $("#tabs .ui-tabs-panel");
    for(var i = 0, len = sortedTimelines.length; i < len; ++i) {
      var correctTimeline = sortedTimelines[i];
      var correctPanel = $("#timeline-" + correctTimeline);
      var positionPanel = panels.eq(i);
      if(correctPanel[0].id != positionPanel[0].id) {
        var currentScroll = $('.inner_timeline', correctPanel).scrollTop();
        correctPanel.detach();
        positionPanel.before(correctPanel);
        $('.inner_timeline', correctPanel).scrollTop(currentScroll);
        panels = $("#tabs .ui-tabs-panel");
      }
    }
  },

  updateTabsOrder: function() {
    var sortedTabs = this.sortableEl.sortable('toArray');
    var sortedTimelines = [];
    for(var i = 0; i < sortedTabs.length; ++i) {
      sortedTimelines[i] = sortedTabs[i].split('-')[1];
    }
    tweetManager.setTimelineOrder(sortedTimelines);
    this.reOrderPanels(sortedTimelines);
    this.uiTabs.tabs('refreshPositions');
  }
};

var Composer = {
  replyId: null,
  replyUser: null,
  rtId: null,
  destroyId: null,
  favoriteId: null,
  destroyTimelineId: null,

  init: function() {
    if(tweetManager.composerData.isComposing) {
      Composer.initMessage(tweetManager.composerData.saveMessage, tweetManager.composerData.replyId,
          tweetManager.composerData.replyUser, false);
    }
    Composer.textareaChanged();
  },

  initMessage: function(message, replyId, replyUser, shouldAnimate) {
    Composer.replyId = replyId;
    Composer.replyUser = replyUser;
    $("#compose_tweet_area textarea").val(message || '');
    Composer.showComposeArea(true, !shouldAnimate);
    Composer.textareaChanged();
  },

  share: function (node) {
    Composer.showComposeArea(true);
    var el = $("#compose_tweet_area textarea");
    var user = $(".user", node).attr('screen_name');
    var msg = $(".text", node).text();
    el.val("RT @" + user + ": " + msg);
    Composer.textareaChanged();
  },

  confirmDestroy: function() {
    $("#loading").show();
    $(".rt_confirm").hide();
    var _this = this;

    tweetManager.destroy(function(success, data, status) {
      $("#loading").hide();
      var notFound = status && status.match(/Not Found/);
      if(success || notFound) {
        $(".tweet[tweetid='" + _this.destroyId + "']").parents('.tweet_space').first().hide('blind', { direction: "vertical" });
        var currentCount = tweetManager.getCurrentTimeline().getTweetsCache().length;
        if(currentCount < OptionsBackend.get('tweets_per_page')) {
          Paginator.nextPage();
        }
      } else {
        Renderer.showError(chrome.i18n.getMessage("ue_deletingTweet", status), 'Composer.confirmDestroy');
      }
    }, this.destroyTimelineId, this.destroyId);
  },

  denyDestroy: function() {
    $(".rt_confirm").hide();
  },

  destroy: function (node) {
    $(".rt_confirm").hide();
    $(".rt_confirm.destroy", node).show();
    this.destroyId = $(node).attr('tweetid');
    this.destroyTimelineId = $(node).attr('timelineid');
  },

  confirmRT: function() {
    $("#loading").show();
    $(".rt_confirm").hide();
    var _this = this;
    tweetManager.postRetweet(function(success, data, status) {
      $("#loading").hide();
      if(success) {
        loadTimeline(true, "home");
      } else {
        Renderer.showError(chrome.i18n.getMessage("ue_retweeting", status), 'Composer.confirmRT');
      }
    }, _this.rtId);
  },

  denyRT: function() {
    $(".rt_confirm").hide();
  },

  retweet: function (node) {
    $(".rt_confirm").hide();
    $(".rt_confirm", node).show();
    this.rtId = $(node).attr('tweetid');
  },

  favorite: function (node) {
    if(node) {
      this.favoriteId = $(node).attr('tweetid');
    }
    $("#loading").show();
    tweetManager.favorite(function(success, data, status) {
      $("#loading").hide();
      if(success) {
         Paginator.needsMore = false;
         loadTimeline();
      } else {
        Renderer.showError(chrome.i18n.getMessage("ue_markFavorite", status), 'Composer.favorite');
      }
    }, this.favoriteId);
  },

  unFavorite: function (node) {
    if(node) {
      this.favoriteId = $(node).attr('tweetid');
    }
    $("#loading").show();
    tweetManager.unFavorite(function(success, data, status) {
      $("#loading").hide();
      if(success) {
         Paginator.needsMore = false;
         loadTimeline();
      } else {
        Renderer.showError(chrome.i18n.getMessage("ue_unmarkFavorite", status), 'Composer.unFavorite');
      }
    }, this.favoriteId);
  },

  addUser: function (user, replies) {
    var textArea = $("#compose_tweet_area textarea");
    var currentVal = textArea.val();
    replies =  replies || [];
    if(currentVal.length > 0 && currentVal[currentVal.length - 1] != ' ') {
      currentVal += ' ';
    }
    currentVal += '@' + user + ' ' + replies.join('');
    textArea.val(currentVal);
  },

  reply: function (node) {
    Composer.showComposeArea(true);

    var textArea = $("#compose_tweet_area textarea");
    var user = $(".user", node).attr('screen_name');
    var timelineId = $(node).attr('timelineid');

    if(timelineId == TimelineTemplate.RECEIVED_DMS || timelineId == TimelineTemplate.SENT_DMS) {
      textArea.val("d " + user + " ");
      Composer.textareaChanged();
      return;
    }

    var currentVal = textArea.val();
    var replies = [];
    var ownName = tweetManager.twitterBackend.username();
    if (reply_all) {
      $(".text a", node).each(function(){
        var t = $(this).text();
        if (t !== ownName && (/^[A-Z0-9_-]{1,15}$/i).test(t)) {
          replies.push('@'+t+' ');
        }
      });
    }

    if(Composer.replyId && currentVal.indexOf(Composer.replyUser) != -1) {
      this.addUser(user, replies);
      Composer.textareaChanged();
      return;
    }

    this.addUser(user, replies);
    tweetManager.composerData.replyId = Composer.replyId = $(node).attr('tweetid');
    tweetManager.composerData.replyUser = Composer.replyUser = user;

    Composer.textareaChanged();
  },

  showComposeArea: function (showOnly, noAnimation) {
    var composeArea = $("#compose_tweet_area");
    var textarea = $("textarea", composeArea);
    var visible = composeArea.is(':visible');

    if(!visible) {
      if(noAnimation) {
        composeArea.show();
      } else {
        composeArea.show('blind', { direction: "vertical" }, 'normal', function() {
          textarea[0].selectionStart = textarea[0].selectionEnd = textarea.val().length;
          textarea.focus();
        });
      }
      $("#compose_tweet img").attr('src', 'img/arrow_up.gif');
      tweetManager.composerData.isComposing = true;
      tweetManager.composerData.replyId = Composer.replyId;
      tweetManager.composerData.replyUser = Composer.replyUser;
    } else if(!showOnly) {
      if(noAnimation) {
        composeArea.hide();
      } else {
        composeArea.hide('blind', { direction: "vertical" });
      }
      $("#compose_tweet img").attr('src', 'img/arrow_down.gif');
      tweetManager.composerData.saveMessage = '';
      tweetManager.composerData.isComposing = false;
      tweetManager.composerData.replyId = null;
      tweetManager.composerData.replyUser = null;
      Shortener.closeArea();
    }

    if((visible && showOnly) || (!visible && noAnimation)) {
      textarea[0].selectionStart = textarea[0].selectionEnd = textarea.val().length;
      textarea.focus();
    }
  },

  textareaChanged: function (e) {
    var el = $("#compose_tweet_area textarea");
    tweetManager.composerData.saveMessage = el.val();
    var availableChars = MAX_TWEET_SIZE - el.val().length;
    var charsLeftEl = $("#compose_tweet_area .chars_left");
    charsLeftEl.text(availableChars);
    if(availableChars < 0 || availableChars == MAX_TWEET_SIZE) {
      if(availableChars < 0) {
        charsLeftEl.css('color', 'red');
      }
      $("#compose_tweet_area input[type='button']").attr("disabled", "disabled");
    } else {
      charsLeftEl.css('color', 'black');
      $("#compose_tweet_area input[type='button']").removeAttr("disabled");
      if(e && e.ctrlKey && e.which == 13) { // Ctrl + Enter
        this.sendTweet();
      }
    }
  },

  sendTweet: function () {
    var textarea = $("#compose_tweet_area textarea");
    tweetManager.enqueueTweet(textarea.val(), Composer.replyId, Composer.replyUser);

    textarea.val("");
    Composer.replyId = null;
    Composer.textareaChanged();
    Composer.showComposeArea();
    Shortener.clear();
  },

  refreshNew: function() {
    // FIXME: #loading shouldn't be used for that.
    if($("#loading").is(":visible")) {
      return;
    }
    loadTimeline(true);
  },

  isVisible: function() {
    var composeArea = $("#compose_tweet_area");
    var textarea = $("textarea", composeArea);
    var visible = composeArea.is(':visible');
    return visible && textarea.val().length > 0;
  },

  addText: function(value) {
    var textarea = $("#compose_tweet_area textarea");
    var tmpText = textarea.val();
    if(tmpText.length > 0) {
      if((textarea[0].selectionStart > 0) &&
        (tmpText[textarea[0].selectionStart-1] != ' ')) {
        value = ' ' + value;
      }
      if((textarea[0].selectionEnd < tmpText.length) &&
         (tmpText[textarea[0].selectionEnd+1] != ' ')) {
         value += ' ';
      }
    }
    textarea.insertAtCaret(value);
    Composer.textareaChanged();
  }
};

var WorkList = {
  /* Not really a work list yet, but I intend in making it into one
     and hopefully stop this #loading madness.
   */
  init: function() {
    if(tweetManager.sendQueue.queueSize() !== 0) {
      $("#queue_loading").show();
    }
    tweetManager.sendQueue.onQueueEmpty(function(lastSent) {
      if(!window) {
        return;
      }
      WorkList.sendQueueEmpty(lastSent);
    });
    tweetManager.sendQueue.onTweetEnqueued(function() {
      if(!window) {
        return;
      }
      WorkList.tweetEnqueued();
    });
    tweetManager.sendQueue.onSendFailed(function() {
      if(!window) {
        return;
      }
      WorkList.sendFailed();
    });
    // Just checking
    WorkList.sendFailed();

    $("#queue_loading").tipsy({
      title: function() {
        var html = '<div class="worklist_container"><span class="title">' +
                   chrome.i18n.getMessage("queued_messages") +
                   '</span>';
        html += '<ul class="worklist">';
        var queueItems = tweetManager.sendQueue.queue;
        for(var i = 0, len = queueItems.length; i < len; ++i) {
          var queueItem = queueItems[i];
          var message = queueItem.message;
          if(i === 0 && message.length > 15) {
            message = message.substring(0, 13) + '...';
          } else if(message.length > 50) {
            message = message.substring(0, 48) + '...';
          }
          html += '<li>';
          html += message;
          if(i === 0) {
            var timeDiff = ((new Date()).getTime() - queueItem.createdAt.getTime()) / 1000;
            var timeDiffDesc;
            if(timeDiff < 60) {
              timeDiffDesc = parseInt(timeDiff, 10) + 's';
            } else {
              timeDiffDesc = parseInt(timeDiff / 60, 10) + 'm';
            }
            if(queueItem.retryCount == 1) {
              html += '<span class="title"> ' +
                      chrome.i18n.getMessage("queue_trying", timeDiffDesc) +
                      '</span>';
            } else {
              html += '<span class="title"> ' +
                      chrome.i18n.getMessage("queue_retried", [queueItem.retryCount, timeDiffDesc, queueItem.lastStatus]) +
                      '</span>';
            }
            if(queueItem.shouldCancel) {
              html += ' <span class="title" style="color: #d00;">' +
                      chrome.i18n.getMessage("canceling") +
                      '</span>';
            } else {
              html += '<img src="img/cancel.png" onclick="WorkList.cancelMessage();" title="' +
                      chrome.i18n.getMessage("cancelTweet") + '">';
            }
          }
          html += '</li>';
        }
        html += '</ul></div>';
        return html;
      },
      html: true,
      opacity: 0.9,
      delayOut: 500,
      persistOnHover: true,
      maxWidth: 400,
      gravity: 'tasks'
    });
  },

  cancelMessage: function() {
    var queueItems = tweetManager.sendQueue.queue;
    if(queueItems.length > 0) {
      queueItems[0].cancel();
    }
    $("#queue_loading").tipsy({refresh: true});
  },

  sendQueueEmpty: function(lastSent) {
    $("#queue_loading").hide();
    var updateTimelineId = TimelineTemplate.HOME;
    if(lastSent && lastSent.message.indexOf('d ') === 0) {
      updateTimelineId = TimelineTemplate.SENT_DMS;
    }
    loadTimeline(true, updateTimelineId);
  },

  tweetEnqueued: function() {
    $("#queue_loading").show();
  },

  sendFailed: function() {
    var abortedQueue = tweetManager.sendQueue.abortedStatus();
    if(!abortedQueue || abortedQueue.length === 0) {
      return;
    }
    // If we're here that's because something went wrong
    if(!Composer.isVisible()) {
      // For now let's just show the first enqueued message
      var topMessage = abortedQueue[0];
      Composer.initMessage(topMessage.message, topMessage.replyId, topMessage.replyUser, true);
    }
    Renderer.showError(chrome.i18n.getMessage("tweet_send_error"));
  }
};

var Shortener = {
  SHORTENER_IDLE_STR: chrome.i18n.getMessage("shortenerIdleString"),

  init: function() {
    var savedUrl = tweetManager.composerData.urlShortener;
    if(savedUrl !== '') {
      $("#shortener_area input").val(savedUrl);
    }
    this.blur();
  },

  clear: function() {
    $("#shortener_area input").val('');
    this.blur();
  },

  closeArea: function() {
    tweetManager.composerData.urlShortener = '';
  },

  focus: function() {
    var shortener = $("#shortener_area input");
    var val = shortener.val();
    if(val == this.SHORTENER_IDLE_STR) {
      shortener.val('');
      shortener.removeAttr('style');
    }
  },

  showButton: function() {
    var shortenerButton = $("#shortener_button div");
    if(!shortenerButton.is(":visible"))
      shortenerButton.show('blind', { direction: "vertical" }, 'fast');
  },

  hideButton: function() {
    var shortenerButton = $("#shortener_button div");
    if(shortenerButton.is(":visible"))
      shortenerButton.hide('blind', { direction: "vertical" }, 'fast');
  },

  blur: function() {
    var shortener = $("#shortener_area input");
    var val = shortener.val();
    if($.trim(val) === '' || val == this.SHORTENER_IDLE_STR) {
      shortener.val(this.SHORTENER_IDLE_STR);
      shortener.attr('style', 'color: #aaa;');
      this.hideButton();
    } else {
      this.showButton();
    }
  },

  changed: function(e) {
    var shortener = $("#shortener_area input");
    var val = shortener.val();
    tweetManager.composerData.urlShortener = val;
    if($.trim(val) !== '') {
      if(e.which == 13) { //Enter key
        this.shortenIt();
      } else {
        this.showButton();
      }
    } else {
      this.hideButton();
    }
  },

  shortenCurrentPage: function() {
    var _this = this;
    chrome.tabs.getSelected(null, function(tab) {
      var shortenerInput = $("#shortener_area input");
      shortenerInput.val(tab.url);
      _this.shortenIt({title: tab.title});
    });
  },

  shortenIt: function(context) {
    var shortenerInput = $("#shortener_area input");
    var longUrl = shortenerInput.val();
    this.shortenPage(longUrl, context);
  },

  shortenPage: function(longUrl, context) {
    $("#loading").show();
    var shortenerInput = $("#shortener_area input");
    shortenerInput.attr('disabled', 'disabled');
    this.hideButton();
    var _this = this;
    shortener.shorten(longUrl, function(success, shortUrl) {
      $("#loading").hide();
      shortenerInput.removeAttr('disabled');
      _this.closeArea();
      _this.clear();
      var textarea = $("#compose_tweet_area textarea");
      if(success && shortUrl) {
        if(context && context.title && OptionsBackend.get('share_include_title')) {
          shortUrl = context.title + ' - ' + shortUrl;
        }
        Composer.addText(shortUrl);
      } else if(!success) {
        Renderer.showError(shortUrl);
      }
      Composer.showComposeArea(true);
    });
  }
};

$.extend(Renderer, {
  assemblyTweets: function (tweets, timelineId) {
    var destination = $("#timeline-" + timelineId + " .inner_timeline");
    if(destination.length === 0)
      return;

    var useColors = true;
    if(OptionsBackend.get('tweets_color_only_unified')) {
      if(timelineId != TimelineTemplate.UNIFIED) {
        useColors = false;
      }
    }

    var nameAttribute = OptionsBackend.get('name_attribute');
    var destinationDom = destination[0];
    destinationDom.innerHTML = "";
    for(var i = 0; i < tweets.length; ++i) {
      destinationDom.appendChild(Renderer.renderTweet(tweets[i], useColors, nameAttribute));
    }

    $(".tweet").live('mouseover mouseout', function(event) {
      if(event.type == 'mouseover') {
        $(".new_actions img:not(.starred)", this).css('display', 'inline');
      } else {
        $(".new_actions img:not(.starred)", this).css('display', 'none');
      }
    });

    var hoverFunc = function(event) {
      var $this = $(this);
      var old_src = $this.attr('src');
      var new_src = old_src;
      var isStarred = $this.is('.starred');
      var isHoverImage = old_src.match(/hover/);
      if((!isStarred && event.type == 'mouseover') || (isStarred && event.type == 'mouseout')) {
        if(!isHoverImage) {
          new_src = old_src.replace(/\.png/, '_hover.png');
        }
      } else {
        if(isHoverImage) {
          new_src = old_src.replace(/_hover/, '');
        }
      }
      $this.attr('src', new_src);
    };
    $(".new_actions img").live('mouseover mouseout', hoverFunc);

    $(".tweet.unread").click(function() {
      tweetManager.readTweet($(this).attr('tweetid'));
      $(this).stop();
      $(this).removeClass('unread');
      $(this).attr('style', '');
    });

    var hoverTimeout = OptionsBackend.get('hover_timeout');
    $(".tweet.unread").hoverFor(hoverTimeout,
      function() {
        //Hovering for <time> seconds, let's read it.
        tweetManager.readTweet($(this).attr('tweetid'));
        $(this).removeClass('unread');
        $(this).attr('style', '');
      },
      function() {
        //Starting countdown to read
        var testEl = $("<div class='tweet' style='display:none'></div>");
        $(document.body).append(testEl);
        var transformation = {};
        jQuery.each(['backgroundColor', 'borderBottomColor', 'borderLeftColor', 'borderRightColor', 'borderTopColor', 'outlineColor'], function(i, attr) {
          var cssAttrName = attr.replace(/([A-Z])/g, '-$1').toLowerCase();
          var originValue = testEl.css(cssAttrName);
          if(originValue)
            transformation[attr] = originValue;
        });
        testEl.remove();
        $(this).animate(transformation, hoverTimeout);
      },
      function() {
        //Countdown aborted
        $(this).stop();
        $(this).attr('style', '');
      }
    );
  },

  markAllAsRead: function() {
    tweetManager.markTimelineAsRead();
    Paginator.needsMore = false;
    loadTimeline();
  },

  warningsCallback: function(msg, isError) {
    if(isError) {
      Renderer.showError(msg);
    } else {
      Renderer.showWarning(msg);
    }
  },

  showWarning: function(msg) {
    $("#warning .img_area img").attr('src', 'img/warning.png');
    Renderer.showMessage(msg);
  },

  showError: function(msg, tryAgainFunction, params) {
    $("#warning .img_area img").attr('src', 'img/error.png');
    if(tryAgainFunction) {
      if(!params) {
        params = '';
      }
      msg += ' <a href="#" onclick="' + tryAgainFunction + '(' + params + '); Renderer.hideMessage(); return false;">' + chrome.i18n.getMessage("tryAgain") + '</a>';
    }
    Renderer.showMessage(msg);
  },

  showMessage: function(msg) {
    $("#warning .content").html(msg);
    $("#absolute_container").slideDown('slow');
  },

  hideMessage: function(msg) {
    var imgSrc = $("#warning .img_area img").attr('src');
    if(imgSrc.match(/warning/)) {
      tweetManager.clearWarning();
    }
    $("#absolute_container").slideUp('slow');
  },

  detach: function() {
    if(!ThemeManager.detachedPos.width || !ThemeManager.detachedPos.height) {
      ThemeManager.detachedPos.width = window.innerWidth;
      ThemeManager.detachedPos.height = window.innerHeight;
    }
    window.open(chrome.extension.getURL('popup.html?detached'), 'cb_popup_window',
      'left=' + ThemeManager.detachedPos.left + ',top=' + (ThemeManager.detachedPos.top - 22) + // Magic 22...
      ',width=' + ThemeManager.detachedPos.width + ',height=' + ThemeManager.detachedPos.height +
      'location=no,menubar=no,resizable=yes,status=no,titlebar=yes,toolbar=no');
    window.close();
  }
});

var Lists = {
  selector_value: '__chromedbird__selector__',
  update_value: '__chromedbird__update_lists__',

  init: function(force) {
    var _this = this;
    tweetManager.lists(force, function(success, lists, status) {
      if(!window) { // Popup closed
        return;
      }
      if(!success) {
        if(force) {
          Renderer.showError(chrome.i18n.getMessage("ue_fetchingLists", status), 'Lists.init', 'true');
          return;
        }
      }
      if(!lists) {
        lists = [];
      }
      tweetManager.eachTimeline(function(timeline) {
        if(timeline.template.id != TimelineTemplate.LISTS) {
          return true;
        }
        var $listSelect = $("select#" + timeline.timelineId + "-selector");
        if($listSelect.length === 0) {
          var pos = tweetManager.getTimelinePosition(timeline.timelineId);
          if(pos == -1) {
            pos = undefined;
          }
          TimelineTab.addTab(timeline.timelineId, '<select id="' + timeline.timelineId + '-selector"></select>', pos);
          $listSelect = $("select#" + timeline.timelineId + "-selector");
        }
        $listSelect.html('');
        $listSelect.append($("<option>").attr('value', _this.selector_value).text(chrome.i18n.getMessage("selectList")));
        for(var j = 0; j < lists.length; ++j) {
          $listSelect.append($("<option>").attr('value', lists[j].uri).text(lists[j].name));
        }
        $listSelect.append($("<option>").attr('value', _this.update_value).text(chrome.i18n.getMessage("updateLists")));
        var selectedListId = tweetManager.getListId(timeline.timelineId);
        if(selectedListId) {
          $listSelect.val(selectedListId);
        }
        $listSelect.simpleSelect({
          change: function(value, label) {
            if(value == _this.selector_value) {
              return false;
            }
            if(value == _this.update_value) {
              Lists.init(true);
              return true;
            }
            var timelineId = this.selectEl.id.split('-')[0];
            tweetManager.changeList(timelineId, value);
            Paginator.firstPage(true);
            prepareAndLoadTimeline();
            return true;
          }
        });
        return true;
      });
      ThemeManager.handleWindowResizing();
    });
  }
};

var ContextMenu = {
  init: function(selector) {
    var _this = this;
    if(!selector) {
      selector = 'ul.ui-tabs-nav';
    }
    $(selector).contextMenu({
      menu: 'tab_context_menu',
      onBeforeShow: function(el) {
        return _this.createMenu(el);
      }
    }, function(action, el, pos) {
      return _this.runMenuAction(action, el, pos);
    });
  },

  initSingleTimeline: function(timelineId) {
    this.init('#tab_\\#timeline-' + timelineId);
  },

  runMenuAction: function(action, el, pos) {
    var actionParts = action.split('-');
    var templateId = actionParts[1];
    if(actionParts[0] == 'show') {
      TimelineTab.addNewTab(templateId);
    } else if(actionParts[0] == 'remove') {
      var timelineId = actionParts[1];
      TimelineTab.removeTab(timelineId);
      ThemeManager.handleWindowResizing();
      ThemeManager.updateTabsOrder();
      if(tweetManager.getCurrentTimeline().template.id == TimelineTemplate.UNIFIED) {
        prepareAndLoadTimeline();
      }
    } else if(actionParts[0] == 'unified') {
      tweetManager.toggleUnified(templateId);
      if(tweetManager.getCurrentTimeline().template.id == TimelineTemplate.UNIFIED) {
        prepareAndLoadTimeline();
      }
    } else if(actionParts[0] == 'notify') {
      tweetManager.toggleNotify(templateId);
    } else if(actionParts[0] == 'icon') {
      tweetManager.toggleChangeIcon(templateId);
    }
  },

  createMenu: function(el) {
    var specificMenu = [];
    var timeline = null;
    if(el.is('.timeline_tab')) {
      timeline = tweetManager.getTimeline(el[0].id.split('-')[1]);
      var label = chrome.i18n.getMessage("remove");
      if(timeline.template.includeInUnified && !timeline.template.multipleTimelines) {
        label = chrome.i18n.getMessage("hide");
      }
      specificMenu.push({action: 'remove-' + timeline.timelineId, label: label + ' Tab'});

      if(timeline.template.id == TimelineTemplate.UNIFIED) {
        specificMenu.push({label: 'separator'});
        TimelineTemplate.eachTimelineTemplate(function(template) {
          if(timeline.template.id == template.id) {
            return true;
          }
          var className = 'check_unmarked';
          if(template.includeInUnified) {
            className = 'check_marked';
          }
          specificMenu.push({action: 'unified-' + template.id, label: template.timelineName, className: className});
          return true;
        });
      } else if(timeline.template.id != TimelineTemplate.FAVORITES) {
        specificMenu.push({label: 'separator'});
        var className = 'check_unmarked';
        if(timeline.template.showOnPageNotification) {
          className = 'check_marked';
        }
        specificMenu.push({action: 'notify-' + timeline.template.id, label: 'Notify', className: className});

        className = 'check_unmarked';
        if(timeline.template.showIconNotification) {
          className = 'check_marked';
        }
        specificMenu.push({action: 'icon-' + timeline.template.id, label: 'Change Icon', className: className});
      }
    }

    var generalMenu = [];
    TimelineTemplate.eachTimelineTemplate(function(template) {
      if(!template.visible || template.multipleTimelines) {
        var label = chrome.i18n.getMessage("show");
        if(template.multipleTimelines) {
          label = chrome.i18n.getMessage("add");
        }
        generalMenu.push({action: 'show-' + template.id, label: label + " " + template.timelineName + ' Tab'});
      }
    });

    if(specificMenu.length > 0 && generalMenu.length > 0) {
      specificMenu.push({label: 'separator'});
    }

    return specificMenu.concat(generalMenu);
  }

};

var SearchTab = {
  addSearchTab: function(timelineId, pos, setFocus) {
    var inputHtml = '<input type="text" spellcheck="false" class="search_selector" id="' + timelineId + '-selector"></input>';
    TimelineTab.addTab(timelineId, inputHtml, pos);
    var inputEl = $('input#' + timelineId + '-selector');
    inputEl.val(tweetManager.getSearchQuery(timelineId));
    if(setFocus) {
      inputEl.focus();
    }

    inputEl.blur(function(e) {
      SearchTab.updateSearchEvent(e);
    });
    inputEl.keyup(function(e) {
      if(e && e.which == 13) { // Enter
        inputEl.blur();
      }
    });
  },

  updateSearchEvent: function(e) {
    var timelineId = e.target.id.split('-')[0];
    var searchQuery = $(e.target).val();
    SearchTab.updateSearch(timelineId, searchQuery, false);
  },

  updateSearch: function(timelineId, searchQuery, isBackground) {
    if(!isBackground) {
      TimelineTab.select(timelineId);
    }
    $('#' + timelineId + '-selector').val(searchQuery);
    if(tweetManager.changeSearch(timelineId, searchQuery)) {
      if(!isBackground) {
        Paginator.firstPage(true);
        prepareAndLoadTimeline();
      }
    }
  }
};

var TimelineTab = {
  init: function() {
    $("#tabs").tabs({
      panelTemplate: '<div class="timeline"><div class="inner_timeline"></div></div>',
      tabTemplate: '<li id="tab_#{href}" class="timeline_tab"><a href="#{href}"><span>#{label}</span></a></li>',
      selected: 0,
      select: function(event, ui) {
        tweetManager.previousTimelineId = tweetManager.currentTimelineId;
        tweetManager.currentTimelineId = ui.panel.id.split('-')[1];
        prepareAndLoadTimeline();
      },
      show: function(event, ui) {
        $('.inner_timeline', ui.panel).scrollTop(tweetManager.getCurrentTimeline().currentScroll);
      }
    });
  },

  addNewTab: function(templateId, automaticallyAdded) {
    var createdTimelines = tweetManager.showTimelineTemplate(templateId);
    if(templateId == TimelineTemplate.LISTS) {
      Lists.init();
    } else {
      for(var i = 0, len = createdTimelines.length; i < len; ++i) {
        var timeline = createdTimelines[i];
        pos = tweetManager.getTimelinePosition(timeline.timelineId);
        if(pos == -1) {
          pos = undefined;
        }
        if(templateId == TimelineTemplate.SEARCH) {
          SearchTab.addSearchTab(timeline.timelineId, pos, !automaticallyAdded);
        } else {
          TimelineTab.addTab(timeline.timelineId, timeline.template.timelineName, pos);
        }
      }
      ThemeManager.handleWindowResizing();
    }
    ThemeManager.updateTabsOrder();
    return createdTimelines;
  },

  addNewSearchTab: function(searchQuery, isBackground) {
    var searchTimeline;
    tweetManager.eachTimeline(function(timeline) {
      if(timeline.template.id == TimelineTemplate.SEARCH && timeline.getSearchQuery() == searchQuery) {
        searchTimeline = timeline;
        return false;
      }
      return true;
    });
    if(!searchTimeline) {
      searchTimeline = TimelineTab.addNewTab(TimelineTemplate.SEARCH, true)[0];
    }
    if(searchQuery) {
      SearchTab.updateSearch(searchTimeline.timelineId, searchQuery, isBackground);
    }
  },

  addTab: function(timelineId, tabName, pos) {
    var tabId = '#timeline-' + timelineId;
    $("#tabs").tabs('add', tabId, tabName, pos);
    var tabEl = $("#timeline-" + timelineId + ' .inner_timeline');
    tabEl.scroll(function(e) {
      var $this = $(this);
      var timeline = tweetManager.getTimeline(timelineId);
      var threshold = 50;
      timeline.currentScroll = $this.scrollTop();
      var maxScroll = $this.attr("scrollHeight") - $this.height();
      if(maxScroll - $this.scrollTop() < threshold) {
        if(!loadingNewTweets) {
          Paginator.nextPage();
        }
      }
    });
    ContextMenu.initSingleTimeline(timelineId);
  },

  removeTab: function(timelineId) {
    if(timelineId == tweetManager.currentTimelineId && tweetManager.previousTimelineId) {
      this.select(tweetManager.previousTimelineId);
    }
    $("#tabs > ul li:has(a[href])").each(function(index, el) {
      if($(el).attr('id') == 'tab_#timeline-' + timelineId) {
        $("#tabs").tabs('remove', index);
        return false;
      }
    });
    tweetManager.hideTimeline(timelineId);
  },

  select: function(timelineId) {
    $("#tabs").tabs('select', '#timeline-' + timelineId);
  }
};

var Autocomplete = {
  startPosition: 0,

  init: function() {
    if(!OptionsBackend.get('show_user_autocomplete')) {
      return;
    }
    var autocompleteElement = null;
    $("#compose_tweet_area textarea").autocomplete({
      source: function(request, response) {
        response(Autocomplete.autocomplete(request.term));
      },
      focus: function(event, ui) {
        var oldLen = this.value.length;
        this.value = this.value.substring(0, Autocomplete.startPosition) + ui.item.value;
        this.setSelectionRange(oldLen, this.value.length);
        return false;
      },
      select: function(event, ui) {
        this.value = this.value.substring(0, Autocomplete.startPosition) + ui.item.value + ' ';
        var valueLen = this.value.length;
        this.setSelectionRange(valueLen, valueLen);
        return false;
      },
      open: function(event, ui) {
        autocompleteElement.menu.element.css({
          overflow: 'auto',
          maxHeight: '200px'
        });
      }
    });
    autocompleteElement = $("#compose_tweet_area textarea").data("autocomplete");
  },

  autocomplete: function(hintStr) {
    var usersList = tweetManager.getFollowingUsers();
    if(usersList === null || usersList.length === 0) {
      return [];
    }
    var lastSpaceIdx = hintStr.lastIndexOf(' ');
    if(hintStr.substr(lastSpaceIdx + 1, 1) == '@') {
      this.startPosition = lastSpaceIdx + 2;
    } else if(lastSpaceIdx == 1 && hintStr.substr(0, 1) == 'd') {
      this.startPosition = 2;
    } else {
      return [];
    }
    hintStr = hintStr.substr(this.startPosition).toLowerCase();
    var validScreenNames = [];
    for(var i = 0, len = usersList.length; i < len; ++i) {
      var user = usersList[i];
      if(user.toLowerCase().indexOf(hintStr) === 0) {
        validScreenNames.push(user);
      }
    }
    return validScreenNames;
  }
};

var ImageUpload = {
  init: function() {
    var _this = this;
    this.progressEl = $('#upload_progress');
    this.loadingEl = $('#loading');
    this.inputEl = $('#image_input')[0];

    // FIXME: This check is here only because of http://crbug.com/61632 and
    // http://crbug.com/28829 (already fixed but not on stable channel yet)
    var hideButton = false;
    var majorVersion = parseInt(navigator.userAgent.match(/Chrome\/(\d+)\./)[1], 10);
    if(majorVersion < 8) {
      hideButton = true;
    }
    if(ThemeManager.isPopup) {
      var platform = navigator.userAgent.match(/\((\w+);/)[1];
      if(platform == 'Macintosh') {
        hideButton = true;
      }
    }
    if(hideButton) {
      $('#upload_button_area').hide();
    }

    var running = UploadManager.registerCallbacks(
      function (success, urlOrError) {
        return _this.onFinish(success, urlOrError);
      },
      function (loaded, total) {
        return _this.onProgress(loaded, total);
      }
    );
    if(running) {
      this.inputEl.disabled = true;
      this.progressEl.show();
      this.loadingEl.show();
    }
  },

  upload: function() {
    this.inputEl.disabled = true;
    this.progressEl.show();
    this.loadingEl.show();

    var files = this.inputEl.files;
    UploadManager.upload(files[0]);
  },

  onFinish: function(success, urlOrError) {
    if(!window) {
      return false;
    }
    this.inputEl.disabled = false;
    this.progressEl.hide();
    this.loadingEl.hide();
    if(success) {
      this.inputEl.value = null;
      Composer.addText(urlOrError);
    } else {
      Renderer.showError(urlOrError, 'ImageUpload.upload');
    }
    return true;
  },

  onProgress: function(loaded, total) {
    if(!window) {
      return false;
    }
    var progress = (loaded / total) * 100.0;
    this.progressEl[0].value = progress;
    return true;
  }
};

var loadingNewTweets = false;

function onTimelineRetrieved(tweets, timelineId) {
  if(!window) {
    //Sanity check, popup might be closed.
    return;
  }

  var timeline = tweetManager.getTimeline(timelineId);
  if(!timeline.template.visible) {
    return;
  }

  $("#loading").hide();
  if(tweets) {
    Paginator.needsMore = false;
    Renderer.assemblyTweets(tweets, timelineId);
    $("#timeline-" + timelineId + ' .inner_timeline').scrollTop(timeline.currentScroll);
  } else {
    var baseErrorMsg = tweetManager.currentError();
    var errorMsg = chrome.i18n.getMessage("ue_updatingTweets", baseErrorMsg);
    if(baseErrorMsg == '(timeout)') {
      errorMsg += chrome.i18n.getMessage("ue_updatingTweets2");
    }
    Renderer.showError(errorMsg, 'loadTimeline');
  }
  loadingNewTweets = false;

  prepareTimelines();
}

function loadTimeline(force, forcedTimeline) {
  loadingNewTweets = true;
  $("#loading").show();
  if(force) {
    Paginator.firstPage();
  }
  var cacheOnly = true;
  if(Paginator.needsMore) {
    cacheOnly = false;
  }
  if(!forcedTimeline) {
    forcedTimeline = tweetManager.currentTimelineId;
  }
  tweetManager.giveMeTweets(forcedTimeline, onTimelineRetrieved, force, cacheOnly);
}

function signout() {
  tweetManager.signout();
  window.close();
}

function suspend(forcedValue) {
  if(forcedValue !== undefined) {
    tweetManager.suspend = forcedValue;
  } else {
    tweetManager.suspend = !tweetManager.suspend;
  }
  if(tweetManager.suspend) {
    var nextOpacity = 0;
    function animateLoop() {
      if(nextOpacity == 1) {
        nextOpacity = 0.1;
      } else {
        nextOpacity = 1;
      }
      $("#suspended_notice").animate({opacity: nextOpacity}, 1500, null, animateLoop);
    }
    $("#suspended_notice").css({opacity: nextOpacity}).show();
    animateLoop();
    $("#suspend_toggle").text(chrome.i18n.getMessage("resume"));
  } else {
    $("#suspended_notice").stop().hide();
    $("#suspend_toggle").text(chrome.i18n.getMessage("suspend"));
  }
}

function showRateLimit() {
  if(!OptionsBackend.get('show_hits_in_popup')) {
    return;
  }

  var resetDateObj = new Date();
  var nowmin = new Date().getMinutes();

  $("#popup_footer").show();
  if(tweetManager.twitterBackend) {
    var hitsInfo = tweetManager.twitterBackend.remainingHitsInfo();
    $("#twitter_hits_left").text("API: "+ hitsInfo[0] + "/" + hitsInfo[2] + ",");

    resetDateObj.setTime(parseInt(hitsInfo[1], 10) * 1000);
    var leftMins = resetDateObj.getMinutes() - nowmin;
    if (leftMins < 0) leftMins = 60 + leftMins;
    $("#twitter_hits_reset").text(leftMins + " mins to reset");
  }
}

function newTweetsAvailable(count, unreadCount, timelineId) {
  if(!window) {
    //Sanity check, popup might be closed.
    return;
  }
  var currentTimeline = tweetManager.currentTimelineId;
  if(timelineId != currentTimeline) {
    if(unreadCount === 0) {
      $("#tab_modifier_" + timelineId).remove();
      return;
    }
    $("#tab_modifier_" + timelineId).remove();
    var timelineTabLink = $("a[href='#timeline-" + timelineId + "']");
    var divEl = $("<div class='tab_modifier'></div>").attr('id', "tab_modifier_" + timelineId);
    timelineTabLink.before(divEl);
    var modWidth = parseInt(timelineTabLink.parent().width(), 10) - 12;
    divEl.css({width: modWidth + 'px'});
    return;
  }
  if(count === 0)
    return;
  var tweets_string = count > 1 ? "tweet_plural" : "tweet_singular";
  $("#update_tweets").text(chrome.i18n.getMessage("newTweetsAvailable", [count, chrome.i18n.getMessage(tweets_string)]));
  $("#update_tweets").fadeIn();
}

function updateNotificationFunc(timeline) {
  var timelineId = timeline.timelineId;
  var newTweetsInfo = tweetManager.newTweetsCount(timelineId);
  var newTweetsCount = newTweetsInfo[0];

  if(timeline.timelineId == tweetManager.currentTimelineId && timeline.currentScroll === 0) {
    if(newTweetsCount > 0) {
      tweetManager.updateNewTweets();
      $("#tab_modifier_" + timelineId).remove();
    }
  } else {
    newTweetsAvailable(newTweetsCount, newTweetsInfo[1], timelineId);
  }
}

function loadNewTweets() {
  Paginator.firstPage(true);
  $("#tab_modifier_" + tweetManager.currentTimelineId).remove();
  $("#update_tweets").fadeOut();

  prepareAndLoadTimeline();
}

function loadTrends() {
  var currentTTLocale = OptionsBackend.get('trending_topics_woeid');

  $("#trending_topics").actionMenu({
    loading: 'img/loading.gif',
    parentContainer: '#workspace'
  });

  tweetManager.retrieveTrendingTopics(function(userData) {
    var actions = [];

    if(userData) {
      for(var i = 0, len = userData.trends.length; i < len; ++i) {
        (function(trendName) {
          actions.push({
            name: trendName,
            action: function(event) {
              TimelineTab.addNewSearchTab(trendName, event.isAlternateClick);
            }
          });
        })(userData.trends[i].name);
      }
    } else {
      actions.push({
        name: 'Error, try again.',
        action: function(event) {
          loadTrends();
        }
      });
    }

    $("#trending_topics").actionMenu({
      actions: actions
    });
  }, currentTTLocale);
}

function prepareTimelines() {
  $("#update_tweets").hide();

  updateNotificationFunc(tweetManager.getCurrentTimeline());
  tweetManager.eachTimeline(function(timeline) {
    if(timeline.timelineId != tweetManager.currentTimelineId) {
      updateNotificationFunc(timeline);
    }
  });
}

function prepareAndLoadTimeline() {
  prepareTimelines();
  loadTimeline();
}

function initializeWorkspace() {
  $(window).unload(function() {
    if(tweetManager) {
      tweetManager.registerWarningsCallback(null);
      tweetManager.registerNewTweetsCallback(null);
    }
  });

  tweetManager.registerNewTweetsCallback(newTweetsAvailable);
  $("#workspace").show();
  ThemeManager.init();

  if(ThemeManager.isPopup) {
    Renderer.setContext('popup');
  } else {
    Renderer.setContext('standalone');
  }

  TimelineTab.init();
  tweetManager.orderedEachTimeline(function(timeline) {
    if(timeline.template.id == TimelineTemplate.SEARCH) {
      SearchTab.addSearchTab(timeline.timelineId);
    } else {
      TimelineTab.addTab(timeline.timelineId, timeline.template.timelineName);
    }
  });
  ThemeManager.handleSortableTabs();

  if(OptionsBackend.get('compose_position') == 'bottom') {
    var composeArea = $("#compose_tweet_area").detach();
    var composeButton = $("#compose_tweet").detach();
    $("#workspace").append(composeArea).append(composeButton);
  }

  //Delay loading, improving responsiveness
  setTimeout(function() {
    ThemeManager.initWindowResizing();
    Lists.init();
    ContextMenu.init();

    TimelineTab.select(tweetManager.currentTimelineId);
    Composer.init();
    Shortener.init();

    prepareAndLoadTimeline();

    var tabEl = $("#timeline-" + tweetManager.currentTimelineId + ' .inner_timeline');
    tabEl.scrollTop(tweetManager.getCurrentTimeline().currentScroll);

    tweetManager.registerWarningsCallback(function(msg) {
      Renderer.warningsCallback.call(Renderer, msg);
    });
    suspend(tweetManager.suspend);
    showRateLimit();

    WorkList.init();
    Autocomplete.init();
    $("#shorten_current").attr("title", chrome.i18n.getMessage("shorten_current"));
    $("#detach_img").attr("title", chrome.i18n.getMessage("detach_window"));

    $("#options_page_link").anyClick(function() {
      openTab(chrome.extension.getURL('options.html'));
    });
    
    loadTrends();
    
    ImageUpload.init();
  }, 0);
}

$(function() {
  $("input.i18n").each(function() {
    $(this).val(chrome.i18n.getMessage(this.id));
  });

  $("span.i18n").each(function() {
    $(this).html(chrome.i18n.getMessage(this.id));
  });

  $("a.i18n").each(function() {
    $(this).html(chrome.i18n.getMessage(this.id));
  });

  if(!twitterBackend.authenticated()) {
    if(twitterBackend.tokenRequested()) {
      $("#enter_pin").show();
    }
    return;
  }

  initializeWorkspace();
});
</script>
</head>
<body>
<div id="error" style="display: none;"></div>

<div id="workspace" style="display: none;">
  <div id="absolute_container">
    <div id="warning">
      <div class="img_area"><img src="img/warning.png" /></div>
      <div class="dismiss" onclick="Renderer.hideMessage();">X</div>
      <div class="content"></div>
      <div style="clear: both;"></div>
    </div>
  </div>

  <div id="compose_tweet_area" style="display: none;">
    <textarea rows="4" onkeyup="Composer.textareaChanged(event);" onblur="Composer.textareaChanged();"></textarea>
    <div id="shortener_area">
      <input type="text" name="shortener_text" onfocus="Shortener.focus();" onkeyup="Shortener.changed(event);" onblur="Shortener.blur();">
      <div id="shorten_current" title="Share current page" onclick="Shortener.shortenCurrentPage();"></div>
      <div id="shortener_button" onclick="Shortener.shortenIt();"><div><span id="shortenIt" class="i18n"></span></div></div>
    </div>
    <div class="footer">
      <input id="tweetit" class="i18n" type="button" onclick="Composer.sendTweet();"/>
      <span id="upload_button_area">
        <img id="attach_icon" src="img/attachment.png"><input id="image_input" type="file" name="media" accept="image/*" onchange="ImageUpload.upload();"/>
      </span>
      <progress id="upload_progress" max="100"></progress>
      <span class="chars_left"></span>
    </div>
  </div>
  <div id="compose_tweet" onclick="Composer.showComposeArea()">
    <img class="left" src="img/arrow_down.gif"/><span id="composeTweet" class="i18n"></span><img class="right" src="img/arrow_down.gif"/>
  </div>

  <span class="header_link_left">
    <a href="javascript:signout()"><span id="logout" class="i18n"></span></a> |
    <a href="#" id="options_page_link"><span id="options" class="i18n"></span></a> |
    <a href="javascript:Composer.refreshNew();"><span id="refresh" class="i18n"></span></a> |
    <a id="suspend_toggle" href="javascript:suspend()"><span id="suspend" class="i18n"></span></a> |
    <a id="trending_topics" href="#" class="i18n">Trends</a>
    <span id="suspended_notice"><span id="autoUpdatesSuspended" class="i18n"></span></span>
  </span>
  <span class="header_link_right">
    <a href="javascript:Renderer.markAllAsRead();"><span id="markAllRead" class="i18n"></span></a>
    <a href="javascript:Renderer.detach();"><img id="detach_img" src="img/up_detach.png"/></a>
  </span>
  <img src="img/loading.gif" id="loading" style="display: none;"/>
  <img src="img/loading.gif" id="queue_loading" style="display: none;"/>
  <div style="clear: both;"></div>

  <div id="update_tweets" onclick="loadNewTweets();"></div>

  <div id="tabs">
    <ul></ul>
  </div>

</div>

<div id="enter_pin" style="display: none;">
  <img src="img/loading.gif" id="loading_oauth" style="display: none;"/>
  <label for="pin">Twitter's OAuth Pin:</label>
  <input type="text" name="pin"><br>
  <input type="button" onclick="myOAuth.registerPin();" class="i18n" id="btnAuthorize" value="Authorize!">
  <br><br>
  <a href="javascript:myOAuth.requestNewToken();"><span id="newToken" class="i18n"></span></a>
</div>
<div id="error_pin" style="display: none;">
</div>

<ul id="tab_context_menu" class="contextMenu">
</ul>
<div id="popup_footer">
  <span id="twitter_hits_left"></span>
  <span id="twitter_hits_reset"></span>
</div>
</body>
</html>
