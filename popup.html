<!DOCTYPE html>
<html>
<head>
<!-- Theme specific CSS files are loaded later by the ThemeManager -->
<link id="base_stylesheet" rel="stylesheet" type="text/css" href="css/base.css" />
<link rel="stylesheet" type="text/css" href="css/simple_select.css" />
<link rel="stylesheet" type="text/css" href="css/tipsy.css" />
<link rel="stylesheet" type="text/css" href="css/jquery.contextMenu.css" />

<script>
var MAX_TWEET_SIZE = 140;
var Persistence = chrome.extension.getBackgroundPage().Persistence;
var urlExpander = chrome.extension.getBackgroundPage().urlExpander;
var tweetManager = chrome.extension.getBackgroundPage().TweetManager.instance;
var twitterBackend = tweetManager.twitterBackend;
var OptionsBackend = chrome.extension.getBackgroundPage().OptionsBackend;
var TimelineTemplate = chrome.extension.getBackgroundPage().TimelineTemplate;

var microbloggingService = OptionsBackend.get('microblogging_service');
var TwitterLib;
if(microbloggingService == 'twitter') {
  TwitterLib = {
    URLS: {
      BASE: 'http://twitter.com/',
      SEARCH: 'http://twitter.com/search?q='
    }
  };
} else if(microbloggingService == 'identica') {
  TwitterLib = {
    URLS: {
      BASE: 'http://identi.ca/',
      SEARCH: 'http://identi.ca/search/notice?q='
    }
  };
}

if(!twitterBackend.authenticated() && !twitterBackend.tokenRequested()) {
  twitterBackend.startAuthentication();
  window.close();
}
</script>

<script type="text/javascript" src="lib/3rdparty/jquery.js"></script>
<script type="text/javascript" src="lib/3rdparty/jquery-ui-custom.js"></script>
<script type="text/javascript" src="lib/3rdparty/jquery.autocomplete.mod.js"></script>
<script type='text/javascript' src='lib/3rdparty/jquery.tipsy.js'></script>
<script type="text/javascript" src="lib/3rdparty/jquery.contextMenu.js"></script>
<script type="text/javascript" src="lib/3rdparty/jquery.insertatcaret.min.js"></script>

<!--script type="text/javascript" src="lib/debug.js"></script-->
<script type="text/javascript" src="lib/shortener_lib.js"></script>
<script type="text/javascript" src="lib/simple_select.js"></script>
<script>
$.ajaxSetup({
  timeout: OptionsBackend.get('request_timeout')
});

var shortener_acct = OptionsBackend.get('shortener_acct');
var shortener_login = null;
var shortener_key = null;
if(shortener_acct) {
  shortener_login = OptionsBackend.get('shortener_login');
  shortener_key = OptionsBackend.get('shortener_key');
}
var reply_all = OptionsBackend.get('reply_all');
var shortener = new Shortener(OptionsBackend.get('url_shortener'),
  shortener_acct, shortener_login, shortener_key);

$.extend($.ui.tabs.prototype, {
  refreshPositions: function() {
    return this._tabify();
  }
});

$.fn.hoverFor = function(time, mainCallback, startingCallback, abortCallback) {
  return this.each(function(){
    var _this = this, timeoutHandle, triggerFired = false;
    $(this).hover(
      function() {
        if(triggerFired)
          return;
        if(startingCallback)
          startingCallback.call(_this);
        timeoutHandle = setTimeout(function() {
          triggerFired = true;
          mainCallback.call(_this);
          timeoutHandle = null;
        }, time);
      },
      function() {
        if(triggerFired)
          return;
        if(timeoutHandle) {
          if(abortCallback)
            abortCallback.call(_this);
          clearTimeout(timeoutHandle);
          timeoutHandle = null;
        }
      }
    );
 });
};

var OAuth = {
  registerPin: function() {
    var pinNumber = $("input[name='pin']").val();
    $("#loading_oauth").show();
    twitterBackend.oauthLib.getAccessToken(pinNumber, function(result) {
      $("#loading_oauth").hide();
      $("#enter_pin").hide();
      if(result) {
        initializeWorkspace();
      } else {
        var errMsg = twitterBackend.oauthLib.error;
        $("#error_pin").show().html(chrome.i18n.getMessage("oAuthError", errMsg));
      }
    });
  },
  requestNewToken: function() {
    twitterBackend.startAuthentication();
    window.close();
  }
};

var Paginator = {
  needsMore: false,
  firstPage: function(shouldScrollTop) {
    this.needsMore = false;
    if(shouldScrollTop) {
      $("#timeline-" + tweetManager.currentTimelineId + ' .inner_timeline').scrollTop(0);
    }
  },
  nextPage: function() {
    this.needsMore = true;
    loadTimeline();
  }
}

var ThemeManager = {
  init: function () {
    $("link.theme").remove();
    var theme = OptionsBackend.get('theme');
    $(theme.split(",")).each(function(i, p) {
      $("<link rel='stylesheet' type='text/css' class='theme' href='" + p + "'>").appendTo(document.head);
    });
    var baseStyle = $("#base_stylesheet")[0];
    if(baseStyle.sheet && baseStyle.sheet.cssRules) {
      var baseRules = baseStyle.sheet.cssRules;
      var fontFamily = OptionsBackend.get('font_family');
      var fontSize = OptionsBackend.get('font_size');
      for(var i = 0, len = baseRules.length; i < len; ++i) {
        var rule = baseRules[i];
        if(rule.selectorText == ".tweet") {
          rule.style.fontFamily = fontFamily;
          rule.style.fontSize = fontSize;
          break;
        }
      }
    }
  },
  setPopupSize: function(width, height, autoFitWidth) {
    width = width || 490;
    if(autoFitWidth) {
      setTimeout(function() {
        var tabsBarWidth = 0;
        $("li.timeline_tab").each(function() {
          tabsBarWidth += $(this).width();
        });
        tabsBarWidth += 40;
        if(tabsBarWidth > width) {
          ThemeManager.setPopupSize(tabsBarWidth, height);
        }
      }, 300);
    }
    $(".timeline").width(width + 'px');
    if(height) {
      $(".inner_timeline,.timeline").height(height + 'px');
    } else {
      $(".inner_timeline,.timeline").height('400px');
    }
  },
  popupSizeData: Persistence.popupSize(),
  handleWindowResizing: function () {
    var sizeArray = ThemeManager.popupSizeData.val();
    if(sizeArray) {
      sizeArray = sizeArray.split('x');
      ThemeManager.setPopupSize(sizeArray[0], sizeArray[1], true);
    } else {
      ThemeManager.setPopupSize(null, null, true);
    }
    $(".timeline").resizable({
      handles: 'e, s, se',
      minWidth: 450,
      resize: function(e, ui) {
        var $this = $(this);
        ThemeManager.setPopupSize($this.width(), $this.height());
      },
      stop: function(e, ui) {
        var $this = $(this);
        ThemeManager.popupSizeData.save($this.width() + 'x' + $this.height());
      }
    });
    $(".ui-resizable-handle").attr('title', chrome.i18n.getMessage("resetSize"));
    $(".ui-resizable-handle").dblclick(function(e) {
      ThemeManager.popupSizeData.remove();
      ThemeManager.setPopupSize(null, null, true);
    });
  },

  sortableEl: null,
  uiTabs: null,
  handleSortableTabs: function() {
    this.uiTabs = $("#tabs");
    this.sortableEl = this.uiTabs.find(".ui-tabs-nav");
    this.sortableEl.sortable({
      stop: function(event, ui) {
        ThemeManager.updateTabsOrder();
      }
    });
  },

  reOrderPanels: function(sortedTimelines) {
    var panels = $("#tabs .ui-tabs-panel");
    for(var i = 0, len = sortedTimelines.length; i < len; ++i) {
      var correctTimeline = sortedTimelines[i];
      var correctPanel = $("#timeline-" + correctTimeline);
      var positionPanel = panels.eq(i);
      if(correctPanel[0].id != positionPanel[0].id) {
        correctPanel.remove();
        positionPanel.before(correctPanel);
        panels = $("#tabs .ui-tabs-panel");
      }
    }
  },

  updateTabsOrder: function() {
    var sortedTabs = this.sortableEl.sortable('toArray');
    var sortedTimelines = [];
    for(var i = 0; i < sortedTabs.length; ++i) {
      sortedTimelines[i] = sortedTabs[i].split('-')[1];
    }
    tweetManager.setTimelineOrder(sortedTimelines);
    this.reOrderPanels(sortedTimelines);
    this.uiTabs.tabs('refreshPositions');
  }
}

var Composer = {
  replyId: null,
  replyUser: null,
  rtId: null,
  destroyId: null,
  favoriteId: null,
  destroyTimelineId: null,

  init: function() {
    if(tweetManager.composerData.isComposing) {
      Composer.replyId = tweetManager.composerData.replyId;
      Composer.replyUser = tweetManager.composerData.replyUser;
      $("#compose_tweet_area textarea").val(tweetManager.composerData.saveMessage || '');
      Composer.showComposeArea(true, true);
    }
    Composer.textareaChanged();
  },

  share: function (node) {
    Composer.showComposeArea(true);
    var el = $("#compose_tweet_area textarea");
    var user = $(".user", node).attr('screen_name');
    var msg = $(".text", node).text();
    el.val("RT @" + user + ": " + msg);
    Composer.textareaChanged();
  },

  confirmDestroy: function() {
    $("#loading").show();
    $(".rt_confirm").hide();
    var _this = this;

    tweetManager.destroy(function(success, data, status) {
      $("#loading").hide();
      var notFound = status && status.match(/Not Found/);
      if(success || notFound) {
        $(".tweet[tweetid='" + _this.destroyId + "']").hide('blind', { direction: "vertical" });
        var currentCount = tweetManager.getCurrentTimeline().getTweetsCache().length;
        if(currentCount < OptionsBackend.get('tweets_per_page')) {
          Paginator.nextPage();
        }
      } else {
        Renderer.showError(chrome.i18n.getMessage("ue_deletingTweet", status), 'Composer.confirmDestroy');
      }
    }, this.destroyTimelineId, this.destroyId);
  },

  denyDestroy: function() {
    $(".rt_confirm").hide();
  },

  destroy: function (node) {
    $(".rt_confirm").hide();
    $(".rt_confirm.destroy", node).show();
    this.destroyId = $(node).attr('tweetid');
    this.destroyTimelineId = $(node).attr('timelineid');
  },

  confirmRT: function() {
    $("#loading").show();
    $(".rt_confirm").hide();
    var _this = this;
    tweetManager.postRetweet(function(success, data, status) {
      $("#loading").hide();
      if(success) {
        loadTimeline(true, "home");
      } else {
        Renderer.showError(chrome.i18n.getMessage("ue_retweeting", status), 'Composer.confirmRT');
      }
    }, _this.rtId);
  },

  denyRT: function() {
    $(".rt_confirm").hide();
  },

  retweet: function (node) {
    $(".rt_confirm").hide();
    $(".rt_confirm", node).show();
    this.rtId = $(node).attr('tweetid');
  },

  favorite: function (node) {
    if(node) {
      this.favoriteId = $(node).attr('tweetid');
    }
    $("#loading").show();
    tweetManager.favorite(function(success, data, status) {
      $("#loading").hide();
      if(success) {
         Paginator.needsMore = false;
         loadTimeline();
      } else {
        Renderer.showError(chrome.i18n.getMessage("ue_markFavorite", status), 'Composer.favorite');
      }
    }, this.favoriteId);
  },

  unFavorite: function (node) {
    if(node) {
      this.favoriteId = $(node).attr('tweetid');
    }
    $("#loading").show();
    tweetManager.unFavorite(function(success, data, status) {
      $("#loading").hide();
      if(success) {
         Paginator.needsMore = false;
         loadTimeline();
      } else {
        Renderer.showError(chrome.i18n.getMessage("ue_unmarkFavorite", status), 'Composer.unFavorite');
      }
    }, this.favoriteId);
  },

  addUser: function (user, replies) {
    var textArea = $("#compose_tweet_area textarea");
    var currentVal = textArea.val();
    var replies =  replies || [];
    if(currentVal.length > 0 && currentVal[currentVal.length - 1] != ' ') {
      currentVal += ' ';
    }
    currentVal += '@' + user + ' ' + replies.join('');
    textArea.val(currentVal);
  },

  reply: function (node) {
    Composer.showComposeArea(true);

    var textArea = $("#compose_tweet_area textarea");
    var user = $(".user", node).attr('screen_name');
    var timelineId = $(node).attr('timelineid');

    if(timelineId == "dms") {
      textArea.val("d " + user + " ");
      Composer.textareaChanged();
      return;
    }

    var currentVal = textArea.val();
    var replies = [];
    var ownName = tweetManager.twitterBackend.username();
    if (reply_all) {
      $(".text a", node).each(function(){
        var t = $(this).text();
        if (t !== ownName && /^[A-Z0-9_-]{1,15}$/i.test(t)) {
          replies.push('@'+t+' ');
        }
      });
    }

    if(Composer.replyId && currentVal.indexOf(Composer.replyUser) != -1) {
      this.addUser(user, replies);
      Composer.textareaChanged();
      return;
    }

    this.addUser(user, replies);
    tweetManager.composerData.replyId = Composer.replyId = $(node).attr('tweetid');
    tweetManager.composerData.replyUser = Composer.replyUser = user;

    Composer.textareaChanged();
  },

  showComposeArea: function (showOnly, noAnimation) {
    var composeArea = $("#compose_tweet_area");
    var textarea = $("textarea", composeArea);
    var visible = composeArea.is(':visible');

    if(!visible) {
      if(noAnimation) {
        composeArea.show();
      } else {
        composeArea.show('blind', { direction: "vertical" }, 'normal', function() {
          textarea[0].selectionStart = textarea[0].selectionEnd = textarea.val().length;
          textarea.focus();
        });
      }
      $("#compose_tweet img").attr('src', 'img/arrow_up.gif');
      tweetManager.composerData.isComposing = true;
      tweetManager.composerData.replyId = Composer.replyId;
      tweetManager.composerData.replyUser = Composer.replyUser;
    } else if(!showOnly) {
      if(noAnimation) {
        composeArea.hide();
      } else {
        composeArea.hide('blind', { direction: "vertical" });
      }
      $("#compose_tweet img").attr('src', 'img/arrow_down.gif');
      tweetManager.composerData.saveMessage = '';
      tweetManager.composerData.isComposing = false;
      tweetManager.composerData.replyId = null;
      tweetManager.composerData.replyUser = null;
      Shortener.closeArea();
    }

    if((visible && showOnly) || (!visible && noAnimation)) {
      textarea[0].selectionStart = textarea[0].selectionEnd = textarea.val().length;
      textarea.focus();
    }
  },

  textareaChanged: function (e) {
    var el = $("#compose_tweet_area textarea");
    tweetManager.composerData.saveMessage = el.val();
    var availableChars = MAX_TWEET_SIZE - el.val().length;
    var charsLeftEl = $("#compose_tweet_area .chars_left");
    charsLeftEl.text(availableChars);
    if(availableChars < 0 || availableChars == MAX_TWEET_SIZE) {
      if(availableChars < 0) {
        charsLeftEl.css('color', 'red');
      }
      $("#compose_tweet_area input[type='button']").attr("disabled", "disabled");
    } else {
      charsLeftEl.css('color', 'black');
      $("#compose_tweet_area input[type='button']").removeAttr("disabled");
      if(e && e.ctrlKey && e.which == 13) { // Ctrl + Enter
        this.sendTweet();
      }
    }
  },

  sendTweet: function () {
    var textarea = $("#compose_tweet_area textarea");
    tweetManager.enqueueTweet(textarea.val(), Composer.replyId);

    textarea.val("");
    Composer.replyId = null;
    Composer.textareaChanged();
    Composer.showComposeArea();
    Shortener.clear();
  },

  refreshNew: function() {
    // FIXME: #loading shouldn't be used for that.
    if($("#loading").is(":visible")) {
      return;
    }
    loadTimeline(true);
  }
}

var WorkList = {
  /* Not really a work list yet, but I intend in making it into one
     and hopefully stop this #loading madness.
   */
  init: function() {
    if(tweetManager.sendQueue.queueSize() != 0) {
      $("#queue_loading").show();
    }
    tweetManager.sendQueue.onQueueEmpty(function() {
      if(!window) {
        return;
      }
      WorkList.sendQueueEmpty();
    });
    tweetManager.sendQueue.onTweetEnqueued(function() {
      if(!window) {
        return;
      }
      WorkList.tweetEnqueued();
    });

    $("#queue_loading").tipsy({
      title: function() {
        var html = '<div class="worklist_container"><span class="title">' +
                   chrome.i18n.getMessage("queued_messages") +
                   '</span>';
        html += '<ul class="worklist">';
        var queueItems = tweetManager.sendQueue.queue;
        for(var i = 0, len = queueItems.length; i < len; ++i) {
          var queueItem = queueItems[i];
          var message = queueItem.message;
          if(i == 0 && message.length > 15) {
            message = message.substring(0, 13) + '...';
          } else if(message.length > 50) {
            message = message.substring(0, 48) + '...';
          }
          html += '<li>';
          html += message;
          if(i == 0) {
            var timeDiff = ((new Date()).getTime() - queueItem.createdAt.getTime()) / 1000;
            var timeDiffDesc;
            if(timeDiff < 60) {
              timeDiffDesc = parseInt(timeDiff) + 's';
            } else {
              timeDiffDesc = parseInt(timeDiff / 60) + 'm';
            }
            if(queueItem.retryCount == 1) {
              html += '<span class="title"> ' +
                      chrome.i18n.getMessage("queue_trying", timeDiffDesc) +
                      '</span>';
            } else {
              html += '<span class="title"> ' +
                      chrome.i18n.getMessage("queue_retried", [queueItem.retryCount, timeDiffDesc, queueItem.lastStatus]) +
                      '</span>';
            }
            if(queueItem.shouldCancel) {
              html += ' <span class="title" style="color: #d00;">' +
                      chrome.i18n.getMessage("canceling") +
                      '</span>';
            } else {
              html += '<img src="img/cancel.png" onclick="WorkList.cancelMessage();" title="' +
                      chrome.i18n.getMessage("cancelTweet") + '">';
            }
          }
          html += '</li>';
        }
        html += '</ul></div>';
        return html;
      },
      html: true,
      opacity: 0.9,
      delayOut: 500,
      persistOnHover: true,
      maxWidth: 400,
      gravity: 'tasks'
    });
  },

  cancelMessage: function() {
    var queueItems = tweetManager.sendQueue.queue;
    if(queueItems.length > 0) {
      queueItems[0].cancel();
    }
    $("#queue_loading").tipsy({refresh: true});
  },

  sendQueueEmpty: function() {
    $("#queue_loading").hide();
    loadTimeline(true, "home");
  },

  tweetEnqueued: function() {
    $("#queue_loading").show();
  },
};

var Shortener = {
  SHORTENER_IDLE_STR: chrome.i18n.getMessage("shortenerIdleString"),

  init: function() {
    var savedUrl = tweetManager.composerData.urlShortener;
    if(savedUrl != '') {
      $("#shortener_area input").val(savedUrl);
    }
    this.blur();
  },

  clear: function() {
    $("#shortener_area input").val('');
    this.blur();
  },

  closeArea: function() {
    tweetManager.composerData.urlShortener = '';
  },

  focus: function() {
    var shortener = $("#shortener_area input");
    var val = shortener.val();
    if(val == this.SHORTENER_IDLE_STR) {
      shortener.val('');
      shortener.removeAttr('style');
    }
  },

  showButton: function() {
    var shortenerButton = $("#shortener_button div");
    if(!shortenerButton.is(":visible"))
      shortenerButton.show('blind', { direction: "vertical" }, 'fast');
  },

  hideButton: function() {
    var shortenerButton = $("#shortener_button div");
    if(shortenerButton.is(":visible"))
      shortenerButton.hide('blind', { direction: "vertical" }, 'fast');
  },

  blur: function() {
    var shortener = $("#shortener_area input");
    var val = shortener.val();
    if($.trim(val) == '' || val == this.SHORTENER_IDLE_STR) {
      shortener.val(this.SHORTENER_IDLE_STR);
      shortener.attr('style', 'color: #aaa;');
      this.hideButton();
    } else {
      this.showButton();
    }
  },

  changed: function(e) {
    var shortener = $("#shortener_area input");
    var val = shortener.val();
    tweetManager.composerData.urlShortener = val;
    if($.trim(val) != '') {
      if(e.which == 13) { //Enter key
        this.shortenIt();
      } else {
        this.showButton();
      }
    } else {
      this.hideButton();
    }
  },

  shortenCurrentPage: function() {
    var _this = this;
    chrome.tabs.getSelected(null, function(tab) {
      var shortenerInput = $("#shortener_area input");
      shortenerInput.val(tab.url);
      _this.shortenIt({title: tab.title});
    });
  },

  shortenIt: function(context) {
    var shortenerInput = $("#shortener_area input");
    var longUrl = shortenerInput.val();
    this.shortenPage(longUrl, context);
  },

  shortenPage: function(longUrl, context) {
    $("#loading").show();
    var shortenerInput = $("#shortener_area input");
    shortenerInput.attr('disabled', 'disabled');
    this.hideButton();
    var _this = this;
    shortener.shorten(longUrl, function(success, shortUrl) {
      $("#loading").hide();
      shortenerInput.removeAttr('disabled');
      _this.closeArea();
      _this.clear();
      var textarea = $("#compose_tweet_area textarea");
      if(success && shortUrl) {
        var tmpText = textarea.val();
        if(tmpText.length > 0) {
          if((textarea[0].selectionStart > 0) &&
            (tmpText[textarea[0].selectionStart-1] != ' ')
          ) {
            shortUrl = ' ' + shortUrl;
          }
          if((textarea[0].selectionEnd < tmpText.length) &&
             (tmpText[textarea[0].selectionEnd+1] != ' ')
          ) {
             shortUrl += ' ';
          }
        }
        if(context && context.title && OptionsBackend.get('share_include_title')) {
          shortUrl = context.title + ' - ' + shortUrl;
        }
        textarea.insertAtCaret(shortUrl);
        Composer.textareaChanged();
      } else if(!success) {
        Renderer.showError(shortUrl);
      }
      Composer.showComposeArea(true);
    });
  }
}

var Renderer = {
  getTimestampText: function (inputTimestampStr) {
    var inputTimestamp = Date.parse(inputTimestampStr);
    var nowTimestamp = new Date().getTime();

    var diff = (nowTimestamp - inputTimestamp) / 1000;
    if(diff < 15) {
      return chrome.i18n.getMessage("justNow");
    } else if(diff < 60) {
      return chrome.i18n.getMessage("minuteAgo");
    } else if(diff < 60 * 60) {
      var minutes = parseInt(diff / 60);
      var minute_string = minutes > 1 ? "minute_plural" : "minute_singular";
      return chrome.i18n.getMessage('minutes', [minutes, chrome.i18n.getMessage(minute_string)]);
    } else if(diff < 60 * 60 * 24) {
      var hours = parseInt(diff / (60 * 60));
      var hour_string = hours > 1 ? "hour_plural" : "hour_singular";
      return chrome.i18n.getMessage("timeAgo", [hours, chrome.i18n.getMessage(hour_string)]);
    } else if(diff < 60 * 60 * 24 * 30) {
      var days = parseInt(diff / (60 * 60 * 24));
      var day_string = days > 1 ? "day_plural" : "day_singular";
      return chrome.i18n.getMessage("timeAgo", [days, chrome.i18n.getMessage(day_string)]);
    } else if(diff < 60 * 60 * 24 * 30 * 12) {
      var months = parseInt(diff / (60 * 60 * 24 * 30));
      var month_string = months > 1 ? "month_plural" : "month_singular";
      return chrome.i18n.getMessage("timeAgo", [months, chrome.i18n.getMessage(month_string)]);
    } else {
      return chrome.i18n.getMessage("yearsAgo");
    }
  },

  getTimestampAltText: function (inputTimestampStr) {
    var inputTimestamp = Date.parse(inputTimestampStr);
    return new Date(inputTimestamp).toLocaleDateString() + " " + new Date(inputTimestamp).toLocaleTimeString();
  },

  geoImage: function (aElement, lat, long, name) {
    var lat = lat.toFixed(6).toString().replace(".", "");
    var long = long.toFixed(6).toString().replace(".", "");
    var url = 'http://maps.google.com/mapdata?cc=EN&min_priority=1&w=160&h=160&latitude_e6=' + lat + '&longitude_e6=' + long + '&zm=2000&Point=b&Point.latitude_e6=' + lat + '&Point.longitude_e6=' + long + '&Point.iconid=33&Point=e';
    $(aElement).tipsy({
      title: function() {
        return '<img src="img/loading.gif" /> ' + chrome.i18n.getMessage("loadingMap");
      },
      image: url,
      html: true,
      showNow: true,
      opacity: 1.0,
      gravity: $.fn.tipsy.autoWE
    });
  },

  expandLink: function (aElement, url) {
    if(!OptionsBackend.get('show_expanded_urls')) {
      return;
    }
    var m = url.match(/http:\/\/(www\.)?(tweetphoto|twitpic|twitgoo|yfrog|movapic).com\/(.*)/);
    if(m) {
      var srcUrl = null;
      if(m[2] == "twitpic" || m[2] == "twitgoo") {
        srcUrl = "http://" + m[2] + ".com/show/thumb/" + m[3];
      } else if(m[2] == "yfrog") {
        srcUrl = "http://yfrog.com/" + m[3] + ".th.jpg";
      } else if(m[2] == "movapic") {
        var iid = m[3].split(/\//)[1];
        srcUrl = "http://image.movapic.com/pic/t_" + iid + ".jpeg";
      } else if(m[2] == "tweetphoto") {
        srcUrl = "http://TweetPhotoAPI.com/api/TPAPI.svc/imagefromurl?url=" + url;
      }
      if(!srcUrl) {
        return;
      }
      $(aElement).tipsy({
        title: function() {
          return '<img src="img/loading.gif" /> ' + chrome.i18n.getMessage("loadingImage");
        },
        image: srcUrl,
        html: true,
        showNow: true,
        opacity: 1.0,
        gravity: $.fn.tipsy.autoWE
      });
      return;
    }
    $(aElement).tipsy({
      title: function() {
        return '<img src="img/loading.gif" /> ' + chrome.i18n.getMessage("loadingLongUrl");
      },
      html: true,
      showNow: true,
      gravity: $.fn.tipsy.autoWE
    });
    urlExpander.expand(url,
      function expanded(success, isShortened, longUrl) {
        if(!isShortened) {
          $(aElement).tipsy({hideNow: true});
          return;
        }
        $(aElement).tipsy({
          title: function() {
            if(!success) {
              return chrome.i18n.getMessage("errorExpandingUrl");
            }
            return longUrl;
          },
          gravity: $.fn.tipsy.autoWE
        });
      }
    );
  },

  transformTweetText: function(oldText) {
    var transformList = [
      {
        //create links (based on John Gruber's pattern from
        //http://daringfireball.net/2009/11/liberal_regex_for_matching_urls
        //
        //I wish JavaScript had character classes
        'expression': /\b(([\w-]+:\/\/?|www[.])[^\s()<>]+((\([\w\d]+\))|([^,.;:'"`~\s]|\/)))/ig,
        'replacement': "<a href='javascript:' onclick=\"javascript:openTab('$1')\" onmouseover=\"Renderer.expandLink(this, '$1')\">$1</a>"
      },
      {
        //create hash search links
        'expression': /([^&\w]|^)(#([\w\u0080-\uffff]*))((?=([^<])*?<a)|(?!.*?<\/a>))/ig,
        'replacement': "$1<a href='javascript:' onclick=\"javascript:openTab('" + TwitterLib.URLS.SEARCH + "%23$3')\">$2</a>"
      },
      {
        //create users links
        'expression': /(@(\w*))((?=([^<])*?<a)|(?!.*?<\/a>))/ig,
        'replacement': "@<a href='javascript:' onclick=\"javascript:openTab('" + TwitterLib.URLS.BASE + "$2')\">$2</a>"
      },
      {
        //line breaks
        'expression': /\r?\n/g,
        'replacement': "<br />"
      }
    ];

    var newText = oldText;
    for(var i = 0; i < transformList.length; ++i) {
      newText = newText.replace(transformList[i]['expression'], transformList[i]['replacement']);
    }
    return newText;
  },

  renderTweet: function (tweet, useColors) {
    var user = tweet.user;
    var text = tweet.text;
    var tweetId = tweet.id;
    if(tweet.retweeted_status) {
      user = tweet.retweeted_status.user
      text = tweet.retweeted_status.text
      tweetId = tweet.retweeted_status.id;
    }
    text = this.transformTweetText(text);

    var tweetTimeline = tweet.timelineId || tweetManager.currentTimelineId;
    var templateId = tweetTimeline.replace(/_.*$/, '');

    var tweetClass = 'tweet';
    if(!tweetManager.isTweetRead(tweet.id)) {
      tweetClass += ' unread';
    }

    var from = null;
    var geo = null;
    if(tweet.source) {
      var tweetSource = tweet.source;
      if(templateId == TimelineTemplate.SEARCH) {
        var htmlNode = document.createElement('div');
        htmlNode.innerHTML = tweet.source;
        tweetSource = htmlNode.textContent;
      }
      from = tweetSource.replace(/(href=(['"])(.*?)\2)/i, "href='#' onclick=\"openTab('$3')\"");
    }
    if(tweet.geo) {
      geo = " <a href=\"#\" onclick=\"openTab('";
      geo += "http://maps.google.com/maps?q=loc:" + tweet.geo.coordinates[0] + "," + tweet.geo.coordinates[1] + " "
      geo += encodeURI("(" + tweet.user.screen_name + ")");
      geo += "')\"";
      geo += "onmouseover=\"Renderer.geoImage(this, " + tweet.geo.coordinates[0] + "," +  tweet.geo.coordinates[1] +  ")\">";
      geo += "<img src=\"data:image/gif;base64, R0lGODlhCgAKAMZZAKRFP7NDN5s5RphLU6dUTLdpVbVZbopycK1vZKNxZqxyZ79oe8hSRMVST8xdTNJaWcRlU8FlWtNzXdVpZsh5atN6aKqEe7yFfsaGa8uVe9GUf791hN55h4yGiI6FipuRkKqHhbasrbi2t8KZg8Cal8mRmuObjMehls+nn/2njvewnMO+u8m6v/ykoPCusubFvsG6wv+/yM3Ex//Lz+7Qxe/Ryf/J2f/lzf/l4f/m5//j7//t7P/47f3z8f/19f/39f/88P/59P/49v/59//69v/69/L6/Pb6/fr4+fj6+f/7+fr8+f79+//9+/z5///4//z7//37///6/v/6//n//fn+//v+//39/f/9/f///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////yH5BAEAAH8ALAAAAAAKAAoAAAdJgH+CfyUbBgs2g38gMzMcAgMugjQXLRMPDQAEgi8KEAEMDhUFgwkUEBIpGBmDFggmKhojgywHJCgkijAeIYqCMh0ivoIfK8OCgQA7\" alt=\"[GEO]\"/></a>";
    }

    var inReply = null;
    if(tweet.in_reply_to_status_id) {
      var linkDst = TwitterLib.URLS.BASE + tweet.in_reply_to_screen_name + '/status/' + tweet.in_reply_to_status_id;
      inReply = '<a href="#" onclick="openTab(\'' + linkDst + '\')">' + chrome.i18n.getMessage("inReply") + ' ' + tweet.in_reply_to_screen_name + '</a> ';
    }

    var nameAttribute = OptionsBackend.get('name_attribute');
    var tweetUserName;
    var tweetTitleUserName;
    if(nameAttribute == "screen_name") {
      tweetUserName = user.screen_name;
      tweetTitleUserName = user.name;
    } else if(nameAttribute == "name") {
      tweetUserName = user.name;
      tweetTitleUserName = user.screen_name;
    } else if(nameAttribute == "both") {
      tweetUserName = user.screen_name + ' (' + user.name + ')';
      tweetTitleUserName = '';
    }

    var str = '<div timelineid="' + tweetTimeline + '" tweetid="' + tweet.id + '" class="' + tweetClass + '">';

    var overlayStyle = '';
    if(useColors) {
      overlayStyle = 'background-color: ' + OptionsBackend.get(templateId + '_tweets_color') + ';';
    }
    str += '<div class="tweet_overlay" style="' + overlayStyle + '">';
    str += '<div class="first_container">';
    if(tweet.retweeted_status) {
      str += '<img class="profile retweet_source" src="' + user.profile_image_url + '" onclick="Renderer.handleUserClick(\'' + user.screen_name + '\', \'' + TwitterLib.URLS.BASE + user.screen_name + '\')" />';
      str += '<img class="profile retweet_retweeter" src="'+ tweet.user.profile_image_url +'"/>'
    } else {
      str += '<img class="profile" src="' + user.profile_image_url + '" onclick="Renderer.handleUserClick(\'' + user.screen_name + '\', \'' + TwitterLib.URLS.BASE + user.screen_name + '\')"></img>';
    }
    str += '<a href="#" class="user" screen_name="' + user.screen_name + '" onclick="Renderer.handleUserClick(\'' + user.screen_name + '\', \'' + TwitterLib.URLS.BASE + user.screen_name + '\')" title="' + tweetTitleUserName + '">' + tweetUserName + '</a>';
    if(user.verified) {
      str += ' <img class="verified" src="img/verified.png" alt="verified" />';
    }
    if(user.protected) {
      str += ' <img class="protected" src="img/lock.png" alt="protected" />';
    }
    str += '<div class="text">';
    if(tweet.retweeted_status) {
      str += '<img class="retweet" src="img/retweet.png">'
    }
    str += text + '</div>';

    str += '<div class="footer">';
    var statusLinkDst = TwitterLib.URLS.BASE + user.screen_name + '/status/' + tweetId;
    str += '<a href="#" onclick="openTab(\'' + statusLinkDst + '\')"><span class="timestamp" title="' + Renderer.getTimestampAltText(tweet.created_at) + '">' + Renderer.getTimestampText(tweet.created_at) + '</span></a> ';
    if(inReply) {
      str += inReply;
    } else if(tweet.retweeted_status) {
      str += chrome.i18n.getMessage("retweetedBy") + ' <a href="#" onclick="openTab(\'' + TwitterLib.URLS.BASE + tweet.user.screen_name + '\');">' + tweet.user.screen_name + '</a> ';
    }
    if(tweetManager.isRetweet(tweet.id)) {
      str += chrome.i18n.getMessage("retweetedByMe") + ' ';
    }
    if(from) {
      str += '<span class="from_app">' + chrome.i18n.getMessage("fromApp") + ' ' + from + '</span>';
    }
    if (geo) {
      str += '<span class="geo_tag">' + geo + '</span>';
    }
    if(templateId == TimelineTemplate.LISTS && tweetManager.currentTimelineId != tweetTimeline) {
      var list = tweetManager.getList(tweetTimeline);
      if(list != null) {
        var path = list.uri.substr(1);
        str += ' (List: <a href="#" onclick="openTab(\''+TwitterLib.URLS.BASE + path + '\');" title="@' + path + '">' + list.name + '</a>)';
      }
    }
    str += '</div></div>';

    str += '<div class="new_actions">';
    if(templateId != TimelineTemplate.DMS) {
      if(tweet.favorited) {
        str += '<img src="img/star_hover.png" title="' +
               chrome.i18n.getMessage("unmarkFavorite") +
               '" class="starred" onclick="Composer.unFavorite(this.parentNode.parentNode.parentNode);"></img><br>';
      } else {
        str += '<img src="img/star.png" title="' +
               chrome.i18n.getMessage("markFavorite") +
               '" class="unstarred" onclick="Composer.favorite(this.parentNode.parentNode.parentNode);"></img><br>';
      }
    }

    if(tweet.user.screen_name == tweetManager.twitterBackend.username()) {
      str += '<img src="img/delete.png" title="' +
             chrome.i18n.getMessage("Delete") +
             '" onclick="Composer.destroy(this.parentNode.parentNode.parentNode)"></img><br>';
      str += '<div class="rt_confirm destroy">' +
             chrome.i18n.getMessage("deleteConfirm") +
             '<a href="javascript:Composer.confirmDestroy();">' +
             chrome.i18n.getMessage("Yes") +
             '</a> <a href="javascript:Composer.denyDestroy();">' +
             chrome.i18n.getMessage("No") +
             '</a></div>';
    } else {
      str += '<img src="img/reply.png" title="' +
             chrome.i18n.getMessage("Reply") +
             '" onclick="Composer.reply(this.parentNode.parentNode.parentNode)"></img><br>';
      if(tweetManager.isRetweet(tweet.id)) {
        //TODO: undo retweet
      } else {
        if(templateId != TimelineTemplate.DMS && !user.protected) {
          str += '<img src="img/rt.png" title="' +
          chrome.i18n.getMessage("Retweet") +
          '" onclick="Composer.retweet(this.parentNode.parentNode.parentNode)"></img><br>';
          str += '<div class="rt_confirm">' +
          chrome.i18n.getMessage("retweetConfirm") +
          '<a href="javascript:Composer.confirmRT();">' +
          chrome.i18n.getMessage("Yes") +
          '</a> <a href="javascript:Composer.denyRT();">' +
          chrome.i18n.getMessage("No") +
          '</a></div>';
        }
      }
      if(!user.protected) {
        str += '<img src="img/share.png" title="' +
        chrome.i18n.getMessage("oldRT") +
        '" onclick="Composer.share(this.parentNode.parentNode.parentNode)"></img><br>';
      }
    }
    str += '</div>';
    str += '<div style="clear: both;"></div>';

    str += '</div></div>'
    return str;
  },

  handleUserClick: function (user, url) {
    // We're gonna do different stuff depending on Composer area status
    var composeArea = $("#compose_tweet_area");
    var visible = composeArea.is(':visible');
    var button = event.button;
    if(!visible || button == 1 || event.ctrlKey) {
      // Composer not visible or Middle click or Ctrl click: Bailing out.
      openTab(url);
      return;
    }
    Composer.addUser(user);
  },

  assemblyTweets: function (tweets, timelineId) {
    var destination = $("#timeline-" + timelineId + " .inner_timeline");
    if(destination.length == 0)
      return;

    var useColors = true;
    if(OptionsBackend.get('tweets_color_only_unified')) {
      if(timelineId != 'unified') {
        useColors = false;
      }
    }

    var destinationDom = destination[0];
    var tweetsArray = [];
    for(var i = 0; i < tweets.length; ++i) {
      tweetsArray[i] = Renderer.renderTweet(tweets[i], useColors);
    }
    destinationDom.innerHTML = tweetsArray.join('');

    $(".tweet").hover(
    function() {
      $(".new_actions img:not(.starred)", this).show();
    },
    function() {
      $(".new_actions img:not(.starred)", this).hide();
    });

    var hoverFunc = function() {
      var $this = $(this);
      var old_src = $this.attr('src');
      var new_src;
      if(old_src.match(/hover/)) {
        new_src = old_src.replace(/_hover/, '');
      } else {
        new_src = old_src.replace(/\.png/, '_hover.png');
      }
      $this.attr('src', new_src);
    }
    $(".new_actions img").hover(hoverFunc, hoverFunc);

    $(".tweet.unread").click(function() {
      tweetManager.readTweet($(this).attr('tweetid'));
      $(this).stop();
      $(this).removeClass('unread');
      $(this).attr('style', '');
    });

    var hoverTimeout = OptionsBackend.get('hover_timeout');
    $(".tweet.unread").hoverFor(hoverTimeout,
      function() {
        //Hovering for <time> seconds, let's read it.
        tweetManager.readTweet($(this).attr('tweetid'));
        $(this).removeClass('unread');
        $(this).attr('style', '');
      },
      function() {
        //Starting countdown to read
        var testEl = $("<div class='tweet' style='display:none'></div>")
        $(document.body).append(testEl);
        var transformation = {};
        jQuery.each(['backgroundColor', 'borderBottomColor', 'borderLeftColor', 'borderRightColor', 'borderTopColor', 'outlineColor'], function(i, attr) {
          var cssAttrName = attr.replace(/([A-Z])/g, '-$1').toLowerCase();
          var originValue = testEl.css(cssAttrName);
          if(originValue)
            transformation[attr] = originValue;
        });
        testEl.remove();
        $(this).animate(transformation, hoverTimeout);
      },
      function() {
        //Countdown aborted
        $(this).stop();
        $(this).attr('style', '');
      }
    );
  },

  markAllAsRead: function() {
    tweetManager.markTimelineAsRead();
    Paginator.needsMore = false;
    loadTimeline();
  },

  warningsCallback: function(msg, isError) {
    if(isError) {
      Renderer.showError(msg);
    } else {
      Renderer.showWarning(msg);
    }
  },

  showWarning: function(msg) {
    $("#warning .img_area img").attr('src', 'img/warning.png');
    Renderer.showMessage(msg);
  },

  showError: function(msg, tryAgainFunction, params) {
    $("#warning .img_area img").attr('src', 'img/error.png');
    if(tryAgainFunction) {
      if(!params) {
        params = '';
      }
      msg += ' <a href="#" onclick="' + tryAgainFunction + '(' + params + '); Renderer.hideMessage();">' + chrome.i18n.getMessage("tryAgain") + '</a>';
    }
    Renderer.showMessage(msg);
  },

  showMessage: function(msg) {
    $("#warning .content").html(msg);
    $("#absolute_container").slideDown('slow');
  },

  hideMessage: function(msg) {
    var imgSrc = $("#warning .img_area img").attr('src');
    if(imgSrc.match(/warning/)) {
      tweetManager.clearWarning();
    }
    $("#absolute_container").slideUp('slow');
  }
}

var Lists = {
  selector_value: '__chromedbird__selector__',
  update_value: '__chromedbird__update_lists__',

  init: function(force) {
    var _this = this;
    tweetManager.lists(force, function(success, lists, status) {
      if(!success) {
        if(force) {
          Renderer.showError(chrome.i18n.getMessage("ue_fetchingLists", status), 'Lists.init', 'true');
          return;
        }
      }
      if(!lists) {
        lists = [];
      }
      tweetManager.eachTimeline(function(timeline) {
        if(timeline.template.id != TimelineTemplate.LISTS) {
          return true;
        }
        var $listSelect = $("select#" + timeline.timelineId + "-selector");
        if($listSelect.length == 0) {
          var pos = tweetManager.getTimelinePosition(timeline.timelineId);
          if(pos == -1) {
            pos = undefined;
          }
          TimelineTab.addTab(timeline.timelineId, '<select id="' + timeline.timelineId + '-selector"></select>', pos);
          $listSelect = $("select#" + timeline.timelineId + "-selector");
        }
        $listSelect.html('');
        $listSelect.append($("<option>").attr('value', _this.selector_value).text(chrome.i18n.getMessage("selectList")));
        for(var j = 0; j < lists.length; ++j) {
          $listSelect.append($("<option>").attr('value', lists[j].uri).text(lists[j].name));
        }
        $listSelect.append($("<option>").attr('value', _this.update_value).text(chrome.i18n.getMessage("updateLists")));
        var selectedListId = tweetManager.getListId(timeline.timelineId);
        if(selectedListId) {
          $listSelect.val(selectedListId);
        }
        $listSelect.simpleSelect({
          change: function(value, label) {
            if(value == _this.selector_value) {
              return false;
            }
            if(value == _this.update_value) {
              Lists.init(true);
              return true;
            }
            var timelineId = this.selectEl.id.split('-')[0];
            tweetManager.changeList(timelineId, value);
            Paginator.firstPage(true);
            prepareAndLoadTimeline();
            return true;
          }
        });
      });
      ThemeManager.handleWindowResizing();
    });
  }
};

var ContextMenu = {
  init: function(selector) {
    var _this = this;
    if(!selector) {
      selector = 'ul.ui-tabs-nav';
    }
    $(selector).contextMenu({
      menu: 'tab_context_menu',
      onBeforeShow: function(el) {
        return _this.createMenu(el);
      }
    }, function(action, el, pos) {
      return _this.runMenuAction(action, el, pos);
    });
  },

  initSingleTimeline: function(timelineId) {
    this.init('#tab_\\#timeline-' + timelineId);
  },

  runMenuAction: function(action, el, pos) {
    var actionParts = action.split('-');
    if(actionParts[0] == 'show') {
      var templateId = actionParts[1];
      var createdTimelines = tweetManager.showTimelineTemplate(templateId);
      if(templateId == TimelineTemplate.LISTS) {
        Lists.init();
      } else {
        for(var i = 0, len = createdTimelines.length; i < len; ++i) {
          var timeline = createdTimelines[i];
          var pos = tweetManager.getTimelinePosition(timeline.timelineId);
          if(pos == -1) {
            pos = undefined;
          }
          if(templateId == TimelineTemplate.SEARCH) {
            SearchTab.addSearchTab(timeline.timelineId, pos, true);
          } else {
            TimelineTab.addTab(timeline.timelineId, timeline.template.timelineName, pos);
          }
        }
        ThemeManager.handleWindowResizing();
      }
      ThemeManager.updateTabsOrder();
    } else if(actionParts[0] == 'remove') {
      var timelineId = actionParts[1];
      TimelineTab.removeTab(timelineId);
      ThemeManager.handleWindowResizing();
      ThemeManager.updateTabsOrder();
      if(tweetManager.getCurrentTimeline().template.id == TimelineTemplate.UNIFIED) {
        prepareAndLoadTimeline();
      }
    } else if(actionParts[0] == 'unified') {
      var templateId = actionParts[1];
      tweetManager.toggleUnified(templateId);
      if(tweetManager.getCurrentTimeline().template.id == TimelineTemplate.UNIFIED) {
        prepareAndLoadTimeline();
      }
    } else if(actionParts[0] == 'notify') {
      var templateId = actionParts[1];
      tweetManager.toggleNotify(templateId);
    } else if(actionParts[0] == 'icon') {
      var templateId = actionParts[1];
      tweetManager.toggleChangeIcon(templateId);
    }
  },

  createMenu: function(el) {
    var specificMenu = [];
    var timeline = null;
    if(el.is('.timeline_tab')) {
      timeline = tweetManager.getTimeline(el[0].id.split('-')[1]);
      var label = chrome.i18n.getMessage("remove");
      if(timeline.template.includeInUnified && !timeline.template.multipleTimelines) {
        label = chrome.i18n.getMessage("hide");
      }
      specificMenu.push({action: 'remove-' + timeline.timelineId, label: label + ' Tab'});

      if(timeline.template.id == TimelineTemplate.UNIFIED) {
        specificMenu.push({label: 'separator'});
        TimelineTemplate.eachTimelineTemplate(function(template) {
          if(timeline.template.id == template.id) {
            return true;
          }
          var className = 'check_unmarked';
          if(template.includeInUnified) {
            className = 'check_marked';
          }
          specificMenu.push({action: 'unified-' + template.id, label: template.timelineName, className: className});
        });
      } else if(timeline.template.id != TimelineTemplate.FAVORITES) {
        specificMenu.push({label: 'separator'});
        var className = 'check_unmarked';
        if(timeline.template.showOnPageNotification) {
          className = 'check_marked';
        }
        specificMenu.push({action: 'notify-' + timeline.template.id, label: 'Notify', className: className});

        className = 'check_unmarked';
        if(timeline.template.showIconNotification) {
          className = 'check_marked';
        }
        specificMenu.push({action: 'icon-' + timeline.template.id, label: 'Change Icon', className: className});
      }
    }

    var generalMenu = [];
    TimelineTemplate.eachTimelineTemplate(function(template) {
      if(!template.visible || template.multipleTimelines) {
        var label = chrome.i18n.getMessage("show");
        if(template.multipleTimelines) {
          label = chrome.i18n.getMessage("add");
        }
        generalMenu.push({action: 'show-' + template.id, label: label + template.timelineName + ' Tab'});
      }
    });

    if(specificMenu.length > 0 && generalMenu.length > 0) {
      specificMenu.push({label: 'separator'});
    }

    return specificMenu.concat(generalMenu);
  }

};

var SearchTab = {
  addSearchTab: function(timelineId, pos, setFocus) {
    var inputHtml = '<input type="text" spellcheck="false" class="search_selector" id="' + timelineId + '-selector"></input>'
    TimelineTab.addTab(timelineId, inputHtml, pos);
    var inputEl = $('input#' + timelineId + '-selector');
    inputEl.val(tweetManager.getSearchQuery(timelineId));
    if(setFocus) {
      inputEl.focus();
    }

    inputEl.blur(function(e) {
      SearchTab.updateSearch(e);
      TimelineTab.select(timelineId);
    });
    inputEl.keyup(function(e) {
      if(e && e.which == 13) { // Enter
        inputEl.blur();
      }
    });
  },

  updateSearch: function(e) {
    var timelineId = e.target.id.split('-')[0];
    if(tweetManager.changeSearch(timelineId, $(e.target).val())) {
      Paginator.firstPage(true);
      prepareAndLoadTimeline();
    }
  }
};

var TimelineTab = {
  init: function() {
    $("#tabs").tabs({
      panelTemplate: '<div class="timeline"><div class="inner_timeline"></div></div>',
      tabTemplate: '<li id="tab_#{href}" class="timeline_tab"><a href="#{href}"><span>#{label}</span></a></li>',
      selected: 0,
      select: function(event, ui) {
        tweetManager.currentTimelineId = ui.panel.id.split('-')[1];
        prepareAndLoadTimeline();
      },
      show: function(event, ui) {
        $('.inner_timeline', ui.panel).scrollTop(tweetManager.getCurrentTimeline().currentScroll);
      }
    });
  },

  addTab: function(timelineId, tabName, pos) {
    var tabId = '#timeline-' + timelineId;
    $("#tabs").tabs('add', tabId, tabName, pos);
    var tabEl = $("#timeline-" + timelineId + ' .inner_timeline');
    tabEl.scroll(function(e) {
      var $this = $(this);
      var timeline = tweetManager.getTimeline(timelineId);
      var threshold = 50;
      timeline.currentScroll = $this.scrollTop();
      var maxScroll = $this.attr("scrollHeight") - $this.height();
      if(maxScroll - $this.scrollTop() < threshold) {
        if(!loadingNewTweets) {
          Paginator.nextPage();
        }
      }
    });
    ContextMenu.initSingleTimeline(timelineId);
  },

  removeTab: function(timelineId) {
    $("#tabs > ul li:has(a[href])").each(function(index, el) {
      if($(el).attr('id') == 'tab_#timeline-' + timelineId) {
        $("#tabs").tabs('remove', index);
        return false;
      }
    });
    tweetManager.hideTimeline(timelineId);
  },

  select: function(timelineId) {
    $("#tabs").tabs('select', '#timeline-' + timelineId);
  }
};

var Autocomplete = {
  startPosition: 0,

  init: function() {
    if(!OptionsBackend.get('show_user_autocomplete')) {
      return;
    }
    var autocompleteElement = null;
    $("#compose_tweet_area textarea").autocomplete({
      source: function(request, response) {
        response(Autocomplete.autocomplete(request.term));
      },
      focus: function(event, ui) {
        var oldLen = this.value.length;
        this.value = this.value.substring(0, Autocomplete.startPosition) + ui.item.value;
        this.setSelectionRange(oldLen, this.value.length);
        return false;
      },
      select: function(event, ui) {
        this.value = this.value.substring(0, Autocomplete.startPosition) + ui.item.value + ' ';
        var valueLen = this.value.length;
        this.setSelectionRange(valueLen, valueLen);
        return false;
      },
      open: function(event, ui) {
        autocompleteElement.menu.element.css({
          overflow: 'auto',
          maxHeight: '200px'
        });
      }
    });
    autocompleteElement = $("#compose_tweet_area textarea").data("autocomplete");
  },

  autocomplete: function(hintStr) {
    var usersList = tweetManager.getUsersToComplete();
    if(usersList == null || usersList.length == 0) {
      return [];
    }
    var lastSpaceIdx = hintStr.lastIndexOf(' ');
    if(hintStr.substr(lastSpaceIdx + 1, 1) == '@') {
      this.startPosition = lastSpaceIdx + 2;
    } else if(lastSpaceIdx == 1 && hintStr.substr(0, 1) == 'd') {
      this.startPosition = 2;
    } else {
      return [];
    }
    hintStr = hintStr.substr(this.startPosition);
    var validScreenNames = [];
    for(var i = 0, len = usersList.length; i < len; ++i) {
      var user = usersList[i];
      if(user.screen_name.indexOf(hintStr) == 0) {
        validScreenNames.push(user.screen_name);
      }
    }
    return validScreenNames;
  }
};

function openTab(tabUrl) {
  if(tabUrl.match(/^www/i)) {
    tabUrl = "http://" + tabUrl;
  }
  window.open(tabUrl);
}

var loadingNewTweets = false;

function onTimelineRetrieved(tweets, timelineId) {
  if(!window) {
    //Sanity check, popup might be closed.
    return;
  }
  if(!tweetManager.getCurrentTimeline().template.visible) {
    return;
  }
  $("#loading").hide();
  if(tweets) {
    Paginator.needsMore = false;
    Renderer.assemblyTweets(tweets, timelineId);
  } else {
    var baseErrorMsg = tweetManager.currentError();
    var errorMsg = chrome.i18n.getMessage("ue_updatingTweets", baseErrorMsg);
    if(baseErrorMsg == '(timeout)') {
      errorMsg += chrome.i18n.getMessage("ue_updatingTweets2");
    }
    Renderer.showError(errorMsg, 'loadTimeline');
  }
  loadingNewTweets = false;

  prepareTimelines();
}

function loadTimeline(force, forcedTimeline) {
  loadingNewTweets = true;
  $("#loading").show();
  if(force) {
    Paginator.firstPage();
  }
  var cacheOnly = true;
  if(Paginator.needsMore) {
    cacheOnly = false;
  }
  if(!forcedTimeline) {
    forcedTimeline = tweetManager.currentTimelineId;
  }
  tweetManager.giveMeTweets(forcedTimeline, onTimelineRetrieved, force, cacheOnly);
}

function signout() {
  tweetManager.signout();
  window.close();
}

function suspend(forcedValue) {
  if(forcedValue !== undefined) {
    tweetManager.suspend = forcedValue;
  } else {
    tweetManager.suspend = !tweetManager.suspend;
  }
  if(tweetManager.suspend) {
    var nextOpacity = 0;
    function animateLoop() {
      if(nextOpacity == 1) {
        nextOpacity = 0.1;
      } else {
        nextOpacity = 1;
      }
      $("#suspended_notice").animate({opacity: nextOpacity}, 1500, null, animateLoop);
    }
    $("#suspended_notice").css({opacity: nextOpacity}).show();
    animateLoop();
    $("#suspend_toggle").text(chrome.i18n.getMessage("resume"));
  } else {
    $("#suspended_notice").stop().hide();
    $("#suspend_toggle").text(chrome.i18n.getMessage("suspend"));
  }
}

function showRateLimit() {
  if(!OptionsBackend.get('show_hits_in_popup')) {
    return;
  }

  var resetDateObj = new Date();
  var nowmin = new Date().getMinutes();

  $("#popup_footer").show();
  if(tweetManager.twitterBackend) {
    var hitsInfo = tweetManager.twitterBackend.remainingHitsInfo();
    $("#twitter_hits_left").text("API: "+ hitsInfo[0] + "/" + hitsInfo[2] + ",");

    resetDateObj.setTime(parseInt(hitsInfo[1]) * 1000);
    var leftMins = resetDateObj.getMinutes() - nowmin;
    if (leftMins < 0) leftMins = 60 + leftMins;
    $("#twitter_hits_reset").text(leftMins + " mins to reset");
  }
}

function newTweetsAvailable(count, unreadCount, timelineId) {
  if(!window) {
    //Sanity check, popup might be closed.
    return;
  }
  var currentTimeline = tweetManager.currentTimelineId;
  if(timelineId != currentTimeline) {
    if(unreadCount == 0) {
      $("#tab_modifier_" + timelineId).remove();
      return;
    }
    $("#tab_modifier_" + timelineId).remove();
    var timelineTabLink = $("a[href='#timeline-" + timelineId + "']");
    var divEl = $("<div class='tab_modifier'></div>")
      .attr('id', "tab_modifier_" + timelineId);
    timelineTabLink.before(divEl);
    var modWidth = parseInt(timelineTabLink.parent().width()) - 12;
    divEl.css({width: modWidth + 'px'});
    return;
  }
  if(count == 0)
    return;
  var tweets_string = count > 1 ? "tweet_plural" : "tweet_singular";
  $("#update_tweets").text(chrome.i18n.getMessage("newTweetsAvailable", [count, chrome.i18n.getMessage(tweets_string)]));
  $("#update_tweets").fadeIn();
}

function updateNotificationFunc(timeline) {
  var timelineId = timeline.timelineId;
  var newTweetsInfo = tweetManager.newTweetsCount(timelineId);
  var newTweetsCount = newTweetsInfo[0];

  if(timeline.timelineId == tweetManager.currentTimelineId && timeline.currentScroll == 0) {
    if(newTweetsCount > 0) {
      tweetManager.updateNewTweets();
      $("#tab_modifier_" + timelineId).remove();
    }
  } else {
    newTweetsAvailable(newTweetsCount, newTweetsInfo[1], timelineId);
  }
}

function loadNewTweets() {
  Paginator.firstPage(true);
  $("#tab_modifier_" + tweetManager.currentTimelineId).remove();
  $("#update_tweets").fadeOut();

  prepareAndLoadTimeline();
}

function prepareTimelines() {
  $("#update_tweets").hide();

  updateNotificationFunc(tweetManager.getCurrentTimeline());
  tweetManager.eachTimeline(function(timeline) {
    if(timeline.timelineId != tweetManager.currentTimelineId) {
      updateNotificationFunc(timeline);
    }
  });
}

function prepareAndLoadTimeline() {
  prepareTimelines();
  loadTimeline();
}

function initializeWorkspace() {
  $(window).unload(function() {
    if(tweetManager) {
      tweetManager.registerWarningsCallback(null);
      tweetManager.registerNewTweetsCallback(null);
    }
  });
  tweetManager.registerNewTweetsCallback(newTweetsAvailable);
  $("#workspace").show();
  ThemeManager.init();

  TimelineTab.init();
  tweetManager.orderedEachTimeline(function(timeline) {
    if(timeline.template.id == TimelineTemplate.SEARCH) {
      SearchTab.addSearchTab(timeline.timelineId);
    } else {
      TimelineTab.addTab(timeline.timelineId, timeline.template.timelineName);
    }
  });
  ThemeManager.handleSortableTabs();

  if(OptionsBackend.get('compose_position') == 'bottom') {
    var composeArea = $("#compose_tweet_area").remove();
    var composeButton = $("#compose_tweet").remove();
    $("#workspace").append(composeArea).append(composeButton);
  }

  //Delay loading, improving responsiveness
  setTimeout(function() {
    ThemeManager.handleWindowResizing();
    Lists.init();
    ContextMenu.init();

    TimelineTab.select(tweetManager.currentTimelineId);
    Composer.init();
    Shortener.init();

    prepareAndLoadTimeline();
    var tabEl = $("#timeline-" + tweetManager.currentTimelineId + ' .inner_timeline');
    tabEl.scrollTop(tweetManager.getCurrentTimeline().currentScroll);

    tweetManager.registerWarningsCallback(function(msg) {
      Renderer.warningsCallback.call(Renderer, msg);
    });
    suspend(tweetManager.suspend);
    showRateLimit();

    WorkList.init();
    Autocomplete.init();
  }, 0);
}

$(function() {
  if(!twitterBackend.authenticated()) {
    if(twitterBackend.tokenRequested()) {
      $("#enter_pin").show();
    }
    return;
  }

  $("input.i18n").each(function() {
    $(this).val(chrome.i18n.getMessage(this.id));
  });

  $("span.i18n").each(function() {
    $(this).html(chrome.i18n.getMessage(this.id));
  });

  initializeWorkspace();

  chrome.tabs.getAllInWindow(null, function(tabs) {
    //Let's make it fullscreen if we're running it in an exclusive window.
    if(tabs.length == 1 && tabs[0].url == chrome.extension.getURL('popup.html')) {
      var resizeWindowFunc = function() {
        var timelineHeight = window.innerHeight - 79;
        $('.timeline').css('maxHeight', timelineHeight + 'px');
      }
      resizeWindowFunc();
      $(window).resize(resizeWindowFunc);
    }
  });
});
</script>
</head>
<body>
<div id="error" style="display: none;"></div>

<div id="workspace" style="display: none;">
  <div id="absolute_container">
    <div id="warning">
      <div class="img_area"><img src="img/warning.png" /></div>
      <div class="dismiss" onclick="Renderer.hideMessage();">X</div>
      <div class="content"></div>
      <div style="clear: both;"></div>
    </div>
  </div>

  <div id="compose_tweet_area" style="display: none;">
    <textarea rows="4" onkeyup="Composer.textareaChanged(event);" onblur="Composer.textareaChanged();"></textarea>
    <div id="shortener_area">
      <input type="text" name="shortener_text" onfocus="Shortener.focus();" onkeyup="Shortener.changed(event);" onblur="Shortener.blur();">
      <div id="shorten_current" title="Share current page" onclick="Shortener.shortenCurrentPage();"></div>
      <div id="shortener_button" onclick="Shortener.shortenIt();"><div><span id="shortenIt" class="i18n"></span></div></div>
    </div>
    <div class="footer">
      <input id="tweetit" class="i18n" type="button" onclick="Composer.sendTweet();"/>
      <span class="chars_left"></span>
    </div>
  </div>
  <div id="compose_tweet" onclick="Composer.showComposeArea()">
    <img class="left" src="img/arrow_down.gif"/><span id="composeTweet" class="i18n"></span><img class="right" src="img/arrow_down.gif"/>
  </div>

  <span class="header_link_left">
    <a href="javascript:signout()"><span id="logout" class="i18n"></span></a> |
    <a href="#" onclick="openTab(chrome.extension.getURL('options.html'))"><span id="options" class="i18n"></span></a> |
    <a href="javascript:Composer.refreshNew();"><span id="refresh" class="i18n"></span></a> |
    <a id="suspend_toggle" href="javascript:suspend()"><span id="suspend" class="i18n"></span></a>
    <span id="suspended_notice"><span id="autoUpdatesSuspended" class="i18n"></span></span>
  </span>
  <a class="header_link_right" href="javascript:Renderer.markAllAsRead();"><span id="markAllRead" class="i18n"></span></a>
  <img src="img/loading.gif" id="loading" style="display: none;"/>
  <img src="img/loading.gif" id="queue_loading" style="display: none;"/>
  <div style="clear: both;"></div>

  <div id="update_tweets" onclick="loadNewTweets();"></div>

  <div id="tabs">
    <ul></ul>
  </div>

</div>

<div id="enter_pin" style="display: none;">
  <img src="img/loading.gif" id="loading_oauth" style="display: none;"/>
  <label for="pin">Twitter's OAuth Pin:</label>
  <input type="text" name="pin"><br>
  <input type="button" onclick="OAuth.registerPin();" class="i18n" id="btnAuthorize" value="Authorize!">
  <br><br>
  <a href="javascript:OAuth.requestNewToken();"><span id="newToken" class="i18n"></span></a>
</div>
<div id="error_pin" style="display: none;">
</div>

<ul id="tab_context_menu" class="contextMenu">
</ul>
<div id="popup_footer">
  <span id="twitter_hits_left"></span>
  <span id="twitter_hits_reset"></span>
</div>
</body>
</html>
