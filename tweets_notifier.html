<!DOCTYPE html>
<html>
<head>
  <script src="lib/3rdparty/jquery.js"></script>
  <script src='lib/3rdparty/jquery.tipsy.js'></script>

  <script src="lib/any_click.js"></script>
  <script src="lib/tweet_transforms.js"></script>
  <script src="lib/timeline_template.js"></script>
  <script src="lib/tweets_assembler.js"></script>

  <link rel="stylesheet" type="text/css" href="css/injectedTweets.css" />
  <link rel="stylesheet" type="text/css" href="css/desktopTweets.css" />
  <link rel="stylesheet" type="text/css" href="css/tipsy.css" />

  <base target="_blank">

  <script>
  var OptionsBackend = chrome.extension.getBackgroundPage().OptionsBackend;
  var urlExpander = chrome.extension.getBackgroundPage().urlExpander;
  var tweetManager = chrome.extension.getBackgroundPage().TweetManager.instance;
  var ImageService = chrome.extension.getBackgroundPage().ImageService;

  chrome.i18n.getMessage = chrome.extension.getBackgroundPage().chrome.i18n.getMessage;

  $(function() {
    var fadeTimeout = OptionsBackend.get('notification_fade_timeout');

    try {
      var tweet = tweetManager.injectTweets.shift();
      Renderer.setContext('desktop');
      $(document.body).prepend(Renderer.renderTweet(tweet, false, OptionsBackend.get('name_attribute')));
    } catch(e) {
      console.log(e);
      window.close();
    }

    setTimeout(function() {
      $("#progress").text(chrome.i18n.getMessage("preventClosing"));
      $('#progress').show().css('bottom', '0px').css('width', '100%').
          animate({width: '0px'}, fadeTimeout, 'linear', function() {
        // Tell manager that this tweet shouldn't be marked as read
        tweetManager.shouldNotReadMap[tweet.id] = true;
        window.close();
      });

      $(document.body).click(function() {
        $('#progress').stop().hide();
      });
    }, 100);

  });
  </script>
</head>
<body>
  <div id="progress"></div>
</body>
</html>
